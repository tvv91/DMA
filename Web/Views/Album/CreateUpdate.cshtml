@model AlbumCreateUpdateViewModel;

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toast_digitization_added" class="toast toast-body-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">Digitization added successfully</div>
    </div>
    <div id="toast_digitization_updated" class="toast toast-body-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">Digitization updated successfully</div>
    </div>
    <div id="toast_digitization_removed" class="toast toast-body-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">Digitization removed successfully</div>
    </div>
</div>
<a class="btn btn-outline-secondary mt-3" asp-action="Index" asp-controller="Album">
    <i class="fa-solid fa-arrow-left"></i> Back
</a>
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>@(Model.Action == Web.Enums.ActionType.Create ? "Add New Album" : "Edit Album")</h3>
    </div>
    <form asp-action="@Model.Action" method="post" onsubmit="onSubmit()">
        <input type="hidden" id="coverid" asp-for="AlbumCover" />
        <input type="hidden" id="albumid" asp-for="AlbumId" />
        <input type="hidden" id="action" asp-for="Action" />
        <div class="card shadow-sm border-1 p-3">
            <div class="row align-items-stretch">
                <div class="col-auto d-flex">
                    <div id="mydropzone" class="dropzone"></div>
                </div>
                <div class="col d-flex flex-column">
                    <ul class="nav nav-tabs" id="mainAlbumTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                General
                            </button>
                        </li>
                        <li class="nav-item digitization-dependent-tab d-none" role="presentation">
                            <button class="nav-link" id="digitization-tab" data-bs-toggle="tab" data-bs-target="#digitization" type="button" role="tab">
                                Digitization
                            </button>
                        </li>
                        <li class="nav-item digitization-dependent-tab d-none" role="presentation">
                            <button class="nav-link" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardware" type="button" role="tab">
                                Hardware
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content border border-top-0 rounded-bottom p-3 bg-light" id="albumTabsContent">
                        <div class="tab-pane fade show active" id="general" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <input id="artist_input" class="form-control" asp-for="Artist" placeholder="Artist" oninput=checkAlbumIsExists(false) />
                                </div>
                                <div class="col-md-12">
                                    <input id="album_input" class="form-control" asp-for="Title" placeholder="Album" oninput=checkAlbumIsExists(false) />
                                </div>
                                <div class="col-md-12">
                                    <input id="genre_input" class="form-control" asp-for="Genre" placeholder="Genre" />
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="digitization" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <input id="vinylstate_input" class="form-control" asp-for="VinylState" placeholder="Vinyl state" />
                                </div>
                                <div class="col-md-4">
                                    <input id="digitalformat_input" class="form-control" asp-for="DigitalFormat" placeholder="Digital format" onchange="checkValidData()" />
                                </div>
                                <div class="col-md-4">
                                    <input id="bitness_input" class="form-control" asp-for="Bitness" placeholder="Bitness" onchange="checkValidData()" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sampling_input" class="form-control" asp-for="Sampling" placeholder="Sampling" onchange="checkValidData()" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sourceformat_input" class="form-control" asp-for="SourceFormat" placeholder="Source format" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Storage" placeholder="Storage" />
                                </div>
                                <div class="col-md-4">
                                    <input id="year_input" class="form-control" asp-for="Year" placeholder="Year" />
                                </div>
                                <div class="col-md-4">
                                    <input id="reissue_input" class="form-control" asp-for="Reissue" placeholder="Reissue" />
                                </div>
                                <div class="col-md-4">
                                    <input id="country_input" class="form-control" asp-for="Country" placeholder="Country" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Label" placeholder="Label" />
                                </div>
                                <div class="col-md-8">
                                    <input id="source_input" class="form-control" asp-for="Source" placeholder="Source" oninput="checkAlbumIsExists(false)" />
                                </div>
                                <div class="col-md-8">
                                    <input class="form-control" asp-for="Discogs" placeholder="Discogs link" />
                                </div>
                                <div class="col-md-4">
                                    <input id="size_input" class="form-control" asp-for="Size" placeholder="Size (GB)" />
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="hardware" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6"><input id="player_input" class="form-control" asp-for="Player" placeholder="Player" /></div>
                                <div class="col-md-6"><input id="player_manufacturer_input" class="form-control" asp-for="PlayerManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="cartridge_input" class="form-control" asp-for="Cartridge" placeholder="Cartridge" /></div>
                                <div class="col-md-6"><input id="cartridge_manufacturer_input" class="form-control" asp-for="CartridgeManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="amp_input" class="form-control" asp-for="Amplifier" placeholder="Amplifier" /></div>
                                <div class="col-md-6"><input id="amp_manufacturer_input" class="form-control" asp-for="AmplifierManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="adc_input" class="form-control" asp-for="Adc" placeholder="ADC" /></div>
                                <div class="col-md-6"><input id="adc_manufacturer_input" class="form-control" asp-for="AdcManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="wire_input" class="form-control" asp-for="Wire" placeholder="Wire" /></div>
                                <div class="col-md-6"><input id="wire_manufacturer_input" class="form-control" asp-for="WireManufacturer" placeholder="Manufacturer" /></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end align-items-center gap-2 mt-4">
                <div id="digitization_warning" class="alert alert-danger alert-dismissible fade m-0 py-1 px-3 d-flex align-items-center justify-content-center flex-grow-1"
                     role="alert"
                     style="white-space: nowrap; min-height: 38px;">
                    <i id="alert-icon" class="me-2"></i>&nbsp
                    <span></span>
                </div>
                <button id="add_digitization_btn" class="btn btn-info px-4" onclick="ShowAddModal()" type="button" disabled>
                    <i class="fa-solid fa-plus"></i> Add
                </button>
                <button id="update_digitization_btn" class="btn btn-warning px-4" onclick="UpdateDigitization()" type="button" disabled>
                    <i class="fa-regular fa-pen-to-square"></i> Update
                </button>
                <button id="remove_digitization_btn" class="btn btn-danger px-4" onclick="ShowRemoveModal()" type="button" disabled>
                    <i class="fa-solid fa-xmark"></i> Remove
                </button>
                <button id="save_album_btn" type="submit" class="btn btn-success px-4">
                    <i class="fa-solid fa-check"></i> Save
                </button>
            </div>
        </div>
    </form>
    <br />
    </div>
    <div class="position-relative shadow-sm border-1 p-3">
        <div class="album-create-update-overlay" id="loader">
            <div class="spinner-border" role="status"></div>
        </div>
        <div id="digitizations-container">
            <div class="album-create-update-no-digitizations" id="no-digitizations">No digitizations</div>
        </div>
    </div>
    <div class="modal fade" id="removeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Removal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to remove this digitization? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="RemoveDigitization()">Remove</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addDigitizationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add new digitization</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card shadow-sm border-1 p-3">
            <div class="row align-items-stretch">
                <div class="col d-flex flex-column">
                    <ul class="nav nav-tabs" id="albumTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="digitization-tab" data-bs-toggle="tab" data-bs-target="#digitizationModal" type="button" role="tab">
                                Digitization
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardwareModal" type="button" role="tab">
                                Hardware
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content border border-top-0 rounded-bottom p-3 bg-light" id="albumTabsContentModal">
                        <div class="tab-pane fade show active" id="digitizationModal" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <input id="vinylstate_input_modal" class="form-control" asp-for="VinylState" placeholder="Vinyl state" />
                                </div>
                                <div class="col-md-4">
                                    <input id="digitalformat_input_modal" class="form-control" asp-for="DigitalFormat" placeholder="Digital format" onchange="checkValidData(true)" />
                                </div>
                                <div class="col-md-4">
                                    <input id="bitness_input_modal" class="form-control" asp-for="Bitness" placeholder="Bitness" onchange="checkValidData(true)" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sampling_input_modal" class="form-control" asp-for="Sampling" placeholder="Sampling" onchange="checkValidData(true)" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sourceformat_input_modal" class="form-control" asp-for="SourceFormat" placeholder="Source format" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Storage" placeholder="Storage" />
                                </div>
                                <div class="col-md-4">
                                    <input id="year_input_modal" class="form-control" asp-for="Year" placeholder="Year" />
                                </div>
                                <div class="col-md-4">
                                    <input id="reissue_input_modal" class="form-control" asp-for="Reissue" placeholder="Reissue" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Country" placeholder="Country" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Label" placeholder="Label" />
                                </div>
                                <div class="col-md-8">
                                    <input id="source_input_modal" class="form-control" asp-for="Source" placeholder="Source" oninput="checkAlbumIsExists(true)" />
                                </div>
                                <div class="col-md-8">
                                    <input class="form-control" asp-for="Discogs" placeholder="Discogs link" />
                                </div>
                                <div class="col-md-4">
                                    <input id="size_input_modal" class="form-control" asp-for="Size" placeholder="Size (GB)" />
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="hardwareModal" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6"><input id="player_input" class="form-control" asp-for="Player" placeholder="Player" /></div>
                                <div class="col-md-6"><input id="player_manufacturer_input" class="form-control" asp-for="PlayerManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="cartridge_input" class="form-control" asp-for="Cartridge" placeholder="Cartridge" /></div>
                                <div class="col-md-6"><input id="cartridge_manufacturer_input" class="form-control" asp-for="CartridgeManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="amp_input" class="form-control" asp-for="Amplifier" placeholder="Amplifier" /></div>
                                <div class="col-md-6"><input id="amp_manufacturer_input" class="form-control" asp-for="AmplifierManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="adc_input" class="form-control" asp-for="Adc" placeholder="ADC" /></div>
                                <div class="col-md-6"><input id="adc_manufacturer_input" class="form-control" asp-for="AdcManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="wire_input" class="form-control" asp-for="Wire" placeholder="Wire" /></div>
                                <div class="col-md-6"><input id="wire_manufacturer_input" class="form-control" asp-for="WireManufacturer" placeholder="Manufacturer" /></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
                <div class="modal-footer">
                    <div id="digitization_warning_modal" class="alert alert-danger alert-dismissible fade m-0 py-1 px-3 d-flex align-items-center justify-content-center flex-grow-1" role="alert" style="white-space: nowrap; min-height: 38px;">
                        <i id="alert-icon-modal" class="me-2"></i>&nbsp
                        <span></span>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="AddDigitization()">Add</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let selectedDigitizationId = 0;
    let digitizations = [];
    let currentAlbumCheckContext = "main";

    function showToast(toastId, message = null) {
        const $toastEl = $('#' + toastId);
        if ($toastEl.length) {
            if (message) {
                const $msgEl = $toastEl.find('.toast-body, #' + toastId + '_msg');
                if ($msgEl.length) {
                    $msgEl.text(message);
                }
            }
            const toast = new bootstrap.Toast($toastEl[0]);
            toast.show();
        }
    }

    function checkAddButtonState() {
        const artist = $("#artist_input").val()?.trim();
        const album = $("#album_input").val()?.trim();
        const genre = $("#genre_input").val()?.trim();
        const hasRequiredFields = artist && album && genre;
        $("#add_digitization_btn").prop("disabled", !hasRequiredFields);
    }

    function checkUpdateRemoveButtons() {
        const enabled = selectedDigitizationId > 0;
        $("#update_digitization_btn").prop("disabled", !enabled);
        $("#remove_digitization_btn").prop("disabled", !enabled);
    }

    function updateDigitizationHardwareTabsVisibility() {
        const show = selectedDigitizationId > 0;
        const $dependentTabs = $("#mainAlbumTabs .digitization-dependent-tab");
        if (show) {
            $dependentTabs.removeClass("d-none");
        } else {
            $dependentTabs.addClass("d-none");
            const generalTabEl = document.getElementById("general-tab");
            if (generalTabEl) {
                bootstrap.Tab.getOrCreateInstance(generalTabEl).show();
            }
        }
    }

    function clearDigitizationFields() {
        $("#vinylstate_input, #digitalformat_input, #bitness_input, #sampling_input, #sourceformat_input").val("");
        $("#year_input, #reissue_input").val("");
        $("#source, #size_input").val("");
        $("#player_input, #cartridge_input, #amp_input, #adc_input, #wire_input").val("");
        $("#player_manufacturer_input, #cartridge_manufacturer_input, #amp_manufacturer_input, #adc_manufacturer_input, #wire_manufacturer_input").val("");
        $("input[placeholder='Country']").val("");
        $("input[placeholder='Label']").val("");
        $("input[placeholder='Storage']").val("");
        $("input[placeholder='Discogs link']").val("");
        selectedDigitizationId = 0;
        checkUpdateRemoveButtons();
        updateDigitizationHardwareTabsVisibility();
    }

    function loadDigitizationToFields(digitization) {
        selectedDigitizationId = digitization.id || digitization.Id;
        // Format Info - handle both camelCase and PascalCase (use ?? so 0 is shown)
        $("#vinylstate_input").val(digitization.vinylState || digitization.VinylState || "");
        $("#digitalformat_input").val(digitization.digitalFormat || digitization.DigitalFormat || "");
        $("#bitness_input").val(digitization.bitness != null ? digitization.bitness : (digitization.Bitness != null ? digitization.Bitness : ""));
        $("#sampling_input").val(digitization.sampling != null ? digitization.sampling : (digitization.Sampling != null ? digitization.Sampling : ""));
        $("#sourceformat_input").val(digitization.sourceFormat || digitization.SourceFormat || "");
        $("#size_input").val(digitization.size != null ? digitization.size : (digitization.Size != null ? digitization.Size : ""));
        
        // Equipment Info - handle both camelCase and PascalCase
        const playerManufacturer = digitization.playerManufacturer || digitization.PlayerManufacturer || "";
        const cartridgeManufacturer = digitization.cartridgeManufacturer || digitization.CartridgeManufacturer || "";
        const amplifierManufacturer = digitization.amplifierManufacturer || digitization.AmplifierManufacturer || "";
        const adcManufacturer = digitization.adcManufacturer || digitization.AdcManufacturer || "";
        const wireManufacturer = digitization.wireManufacturer || digitization.WireManufacturer || "";
        
        // Set equipment names
        $("#player_input").val(digitization.player || digitization.Player || "");
        $("#cartridge_input").val(digitization.cartridge || digitization.Cartridge || "");
        $("#amp_input").val(digitization.amplifier || digitization.Amplifier || "");
        $("#adc_input").val(digitization.adc || digitization.Adc || "");
        $("#wire_input").val(digitization.wire || digitization.Wire || "");
        
        // Set manufacturer fields
        $("#player_manufacturer_input").val(playerManufacturer);
        $("#cartridge_manufacturer_input").val(cartridgeManufacturer);
        $("#amp_manufacturer_input").val(amplifierManufacturer);
        $("#adc_manufacturer_input").val(adcManufacturer);
        $("#wire_manufacturer_input").val(wireManufacturer);
        
        // Other fields - handle both camelCase and PascalCase
        $("#year_input").val(digitization.year || digitization.Year || "");
        $("#reissue_input").val(digitization.reissue || digitization.Reissue || "");
        
        // Country, Label, Storage, Discogs
        $("input[placeholder='Country']").val(digitization.country || digitization.Country || "");
        $("input[placeholder='Label']").val(digitization.label || digitization.Label || "");
        $("input[placeholder='Storage']").val(digitization.storage || digitization.Storage || "");
        $("input[placeholder='Discogs link']").val(digitization.discogs || digitization.Discogs || "");
        $("#source_input").val(digitization.source || digitization.Source || "");

        checkUpdateRemoveButtons();
        updateDigitizationHardwareTabsVisibility();
    }

    function renderDigitizations(digs) {
        digitizations = digs || [];
        const $container = $("#digitizations-container");
        $container.empty();
        
        if (!digs || digs.length === 0) {
            $container.html('<div class="album-create-update-no-digitizations" id="no-digitizations">No digitizations</div>');
            selectedDigitizationId = 0;
            checkUpdateRemoveButtons();
            updateDigitizationHardwareTabsVisibility();
            $("#loader").hide();
            return;
        }
        
        const $table = $(`
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">VS</th>
                        <th scope="col">BTS</th>
                        <th scope="col">SMP</th>
                        <th scope="col">FMT</th>
                        <th scope="col">SRC</th>
                        <th scope="col">PLR</th>
                        <th scope="col">CRT</th>
                        <th scope="col">AMP</th>
                        <th scope="col">ADC</th>
                        <th scope="col">WIR</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        `);
        
        const $tbody = $table.find("tbody");
        
        digs.forEach(dig => {
            const digId = dig.id || dig.Id;
            const $row = $(`
                <tr class="digitization-row ${selectedDigitizationId === digId ? 'table-active' : ''}" data-id="${digId}" style="cursor: pointer;">
                    <td>${dig.vinylState || dig.VinylState || '-'}</td>
                    <td>${(dig.bitness || dig.Bitness) ? (dig.bitness || dig.Bitness) + 'bit' : '-'}</td>
                    <td>${dig.sampling || dig.Sampling || '-'}</td>
                    <td>${dig.digitalFormat || dig.DigitalFormat || '-'}</td>
                    <td>${dig.source || dig.Source || '-'}</td>
                    <td>${dig.player || dig.Player || '-'}</td>
                    <td>${dig.cartridge || dig.Cartridge || '-'}</td>
                    <td>${dig.amplifier || dig.Amplifier || '-'}</td>
                    <td>${dig.adc || dig.Adc || '-'}</td>
                    <td>${dig.wire || dig.Wire || '-'}</td>
                </tr>
            `);
            
            $row.on("click", function() {
                $(".digitization-row").removeClass("table-active");
                $(this).addClass("table-active");
                const clickedDigId = $(this).data("id");
                const clickedDig = digitizations.find(d => (d.id === clickedDigId) || (d.Id === clickedDigId));
                if (clickedDig) {
                    loadDigitizationToFields(clickedDig);
                }
            });
            
            $tbody.append($row);
        });
        
        $container.append($table);
        $("#loader").hide();
    }

    async function AddDigitization() {
        const req = {
            albumId: Number($("#albumid").val()) || 0,
            digitizationId: 0,
            artist: $("#artist_input").val()?.trim() || "",
            album: $("#album_input").val()?.trim() || "",
            genre: $("#genre_input").val()?.trim() || "",
            source: $("#source").val()?.trim() || null,
            discogs: $("input[placeholder='Discogs link']").val()?.trim() || null,
            isFirstPress: false,
            country: $("input[placeholder='Country']").val()?.trim() || null,
            label: $("input[placeholder='Label']").val()?.trim() || null,
            storage: $("input[placeholder='Storage']").val()?.trim() || null,
            year: $("#year_input").val() ? Number($("#year_input").val()) : null,
            reissue: $("#reissue_input").val() ? Number($("#reissue_input").val()) : null,
            size: $("#size_input").val() ? parseFloat($("#size_input").val().replace(",", ".")) : null,
            vinylState: $("#vinylstate_input").val()?.trim() || null,
            digitalFormat: $("#digitalformat_input").val()?.trim() || null,
            bitness: $("#bitness_input").val() ? Number($("#bitness_input").val()) : null,
            sampling: $("#sampling_input").val() ? parseFloat($("#sampling_input").val().replace(",", ".")) : null,
            sourceFormat: $("#sourceformat_input").val()?.trim() || null,
            player: $("#player_input").val()?.trim() || null,
            playerManufacturer: $("#player_manufacturer_input").val()?.trim() || null,
            cartridge: $("#cartridge_input").val()?.trim() || null,
            cartridgeManufacturer: $("#cartridge_manufacturer_input").val()?.trim() || null,
            amplifier: $("#amp_input").val()?.trim() || null,
            amplifierManufacturer: $("#amp_manufacturer_input").val()?.trim() || null,
            adc: $("#adc_input").val()?.trim() || null,
            adcManufacturer: $("#adc_manufacturer_input").val()?.trim() || null,
            wire: $("#wire_input").val()?.trim() || null,
            wireManufacturer: $("#wire_manufacturer_input").val()?.trim() || null
        };
        
        $("#loader").show();
        try {
            await connection.invoke("AddDigitization", connection.connectionId, req);
        } catch (err) {
            console.error("Error adding digitization:", err);
            $("#loader").hide();
            showToast("toast_digitization_error", "Error adding digitization: " + err.message);
        }
    }

    async function UpdateDigitization() {
        if (selectedDigitizationId === 0) {
            showToast("toast_digitization_warning", "Please select a digitization to update");
            return;
        }
        
        const req = {
            albumId: Number($("#albumid").val()) || 0,
            digitizationId: selectedDigitizationId,
            artist: $("#artist_input").val()?.trim() || "",
            album: $("#album_input").val()?.trim() || "",
            genre: $("#genre_input").val()?.trim() || "",
            source: $("#source").val()?.trim() || null,
            discogs: $("input[placeholder='Discogs link']").val()?.trim() || null,
            isFirstPress: false,
            country: $("input[placeholder='Country']").val()?.trim() || null,
            label: $("input[placeholder='Label']").val()?.trim() || null,
            storage: $("input[placeholder='Storage']").val()?.trim() || null,
            year: $("#year_input").val() ? Number($("#year_input").val()) : null,
            reissue: $("#reissue_input").val() ? Number($("#reissue_input").val()) : null,
            size: $("#size_input").val() ? parseFloat($("#size_input").val().replace(",", ".")) : null,
            vinylState: $("#vinylstate_input").val()?.trim() || null,
            digitalFormat: $("#digitalformat_input").val()?.trim() || null,
            bitness: $("#bitness_input").val() ? Number($("#bitness_input").val()) : null,
            sampling: $("#sampling_input").val() ? parseFloat($("#sampling_input").val().replace(",", ".")) : null,
            sourceFormat: $("#sourceformat_input").val()?.trim() || null,
            player: $("#player_input").val()?.trim() || null,
            playerManufacturer: $("#player_manufacturer_input").val()?.trim() || null,
            cartridge: $("#cartridge_input").val()?.trim() || null,
            cartridgeManufacturer: $("#cartridge_manufacturer_input").val()?.trim() || null,
            amplifier: $("#amp_input").val()?.trim() || null,
            amplifierManufacturer: $("#amp_manufacturer_input").val()?.trim() || null,
            adc: $("#adc_input").val()?.trim() || null,
            adcManufacturer: $("#adc_manufacturer_input").val()?.trim() || null,
            wire: $("#wire_input").val()?.trim() || null,
            wireManufacturer: $("#wire_manufacturer_input").val()?.trim() || null
        };
        
        $("#loader").show();
        try {
            await connection.invoke("UpdateDigitization", connection.connectionId, req);
        } catch (err) {
            console.error("Error updating digitization:", err);
            $("#loader").hide();
            showToast("toast_digitization_error", "Error updating digitization: " + err.message);
        }
    }

    function ShowAddModal() {
        const modal = new bootstrap.Modal(document.getElementById("addDigitizationModal"));
        modal.show();
    }

    function ShowRemoveModal() {
        if (selectedDigitizationId === 0) {
            showToast("toast_digitization_warning", "Please select a digitization to remove");
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById("removeModal"));
        modal.show();
    }

    async function RemoveDigitization() {
        if (selectedDigitizationId === 0) return;
        
        $("#loader").show();
        const modal = bootstrap.Modal.getInstance(document.getElementById("removeModal"));
        modal.hide();
        
        try {
            await connection.invoke("RemoveDigitization", connection.connectionId, selectedDigitizationId);
        } catch (err) {
            console.error("Error removing digitization:", err);
            $("#loader").hide();
            showToast("toast_digitization_error", "Error removing digitization: " + err.message);
        }
    }

    function prepareAlbumLink(id) {
        return id 
            ? `<a href="/album/${id}" target="_blank" class="alert-link">Album</a>`
            : "";
    }

    const alertMessages = {
        0: { 
            type: "success", 
            text: "No duplicates found." 
        },
        1: { 
            type: "danger", 
            text: (id) => `${prepareAlbumLink(id)} already exists.`  
        },
        50: { 
            type: "warning", 
            text: "Digitization already exists. Please check to make sure this is not a duplicate."
        },
        100: { 
            type: "danger", 
            text: "Digitization already exists with that source."
        }
    };

    const levels = {
        "alert-success": { icon: "fa-solid fa-circle-check" },
        "alert-warning": { icon: "fa-solid fa-circle-exclamation" },
        "alert-danger":  { icon: "fa-solid fa-triangle-exclamation" }
    };

    const actions = {
        "Create": "albumcreated",
        "Update": "albumupdated"
    };

    const dsdFormats = {
        dsd64:  "2.8",
        dsd128: "5.6",
        dsd256: "11.2",
        dsd512: "22.5"
    };

    $(document).ready(async () => {
        await start();
        
        // Initialize button states
        checkAddButtonState();
        checkUpdateRemoveButtons();
        updateDigitizationHardwareTabsVisibility();
        
        // Set up field change listeners
        $("#artist_input, #album_input, #genre_input").on("input", checkAddButtonState);
        $("#vinylstate_input, #digitalformat_input, #bitness_input, #sampling_input, #sourceformat_input, #year_input, #reissue_input, #source, #size_input, #player_input, #cartridge_input, #amp_input, #adc_input, #wire_input").on("input", checkAddButtonState);
        
        // Load existing digitizations if any
        @if (Model.Digitizations?.Any() == true)
        {
            <text>
            const existingDigs = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Digitizations.Select(d => new {
                id = d.Id,
                vinylState = d.FormatInfo?.VinylState?.Name,
                bitness = d.FormatInfo?.Bitness?.Value,
                sampling = d.FormatInfo?.Sampling?.Value,
                digitalFormat = d.FormatInfo?.DigitalFormat?.Name,
                sourceFormat = d.FormatInfo?.SourceFormat?.Name,
                player = d.EquipmentInfo?.Player?.Name,
                playerManufacturer = d.EquipmentInfo?.Player?.Manufacturer?.Name ?? "",
                cartridge = d.EquipmentInfo?.Cartridge?.Name,
                cartridgeManufacturer = d.EquipmentInfo?.Cartridge?.Manufacturer?.Name ?? "",
                amplifier = d.EquipmentInfo?.Amplifier?.Name,
                amplifierManufacturer = d.EquipmentInfo?.Amplifier?.Manufacturer?.Name ?? "",
                adc = d.EquipmentInfo?.Adc?.Name,
                adcManufacturer = d.EquipmentInfo?.Adc?.Manufacturer?.Name ?? "",
                wire = d.EquipmentInfo?.Wire?.Name,
                wireManufacturer = d.EquipmentInfo?.Wire?.Manufacturer?.Name ?? "",
                source = d.Source,
                year = d.Year?.Value,
                reissue = d.Reissue?.Value,
                country = d.Country?.Name,
                label = d.Label?.Name,
                storage = d.Storage?.Data,
                discogs = d.Discogs,
                size = d.Size
            }), new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
            renderDigitizations(existingDigs);
            $("#loader").hide();
            </text>
        }
        else
        {
            <text>
            $("#loader").hide();
            </text>
        }
    });

    connection.onclose(async () => {
        await start();
    });

    // Map field IDs to EntityType enum values
    const fieldEntityMap = {
        "artist_input": "Artist",
        "genre_input": "Genre",
        "vinylstate_input": "VinylState",
        "digitalformat_input": "DigitalFormat",
        "bitness_input": "Bitness",
        "sampling_input": "Sampling",
        "sourceformat_input": "SourceFormat",
        "year_input": "Year",
        "reissue_input": "Reissue",
        "player_input": "Player",
        "cartridge_input": "Cartridge",
        "amp_input": "Amplifier",
        "adc_input": "Adc",
        "wire_input": "Wire",
        "country_input": "Country",
        "label_input": "Label",
        "storage_input": "Storage"
    };

    // Map equipment fields to their manufacturer entity types
    const equipmentManufacturerMap = {
        "player_input": "PlayerManufacturer",
        "cartridge_input": "CartridgeManufacturer",
        "amp_input": "AmplifierManufacturer",
        "adc_input": "AdcManufacturer",
        "wire_input": "WireManufacturer"
    };

    $(() => {
        $("input:is([id$='_input'], [id$='_input_modal'])").each(function () {
            const $input = $(this);
            const fieldId = this.id;
            const entityType = fieldEntityMap[fieldId];

            if (entityType) {
                $input.autocomplete({
                    source: (request, response) => {
                        if (request.term.length < 2) {
                            response([]);
                            return;
                        }
                        $.getJSON(`/search/${entityType}`, { value: request.term })
                            .done(function(data) {
                                // Transform response to jQuery UI format
                                const items = data.map(item => ({
                                    label: item.label || item.value,
                                    value: item.value || item.label
                                }));
                                response(items);
                            })
                            .fail(function() {
                                response([]);
                            });
                    },
                    delay: 300,
                    minLength: 2,
                    messages: {
                        noResults: '',
                        results: () => {}
                    },
                    select: function (event, ui) {
                        // Auto-fill manufacturer for equipment fields
                        const manufacturerType = equipmentManufacturerMap[fieldId];
                        if (manufacturerType) {
                            getManufacturer(manufacturerType, ui.item.value);
                        }
                    }
                });
            }
        });        
    });

    async function getManufacturer(manufacturerType, equipmentValue) {
        if (!manufacturerType || !equipmentValue) return;
        
        try {
            // Convert manufacturer type to equipment category for SignalR
            const categoryMap = {
                "PlayerManufacturer": "player",
                "CartridgeManufacturer": "cartridge",
                "AmplifierManufacturer": "amplifier",
                "AdcManufacturer": "adc",
                "WireManufacturer": "wire"
            };
            
            const category = categoryMap[manufacturerType];
            if (category) {
                await connection.invoke("GetManufacturer", connection.connectionId, category, equipmentValue);
            }
        } catch (err) {
            console.error("Error getting manufacturer:", err);
        }
    }

    function showAlert(alertId, alertLevel, message) {
        const $alert = $(`#${alertId}`);
        const $icon = $alert.find("i");
        const $body = $alert.find("span");

        $alert.removeClass((_, cls) => (cls.match(/alert-\S+/g) || []).join(" "));
        $icon.removeClass();

        if (levels[alertLevel]) {
            $icon.addClass(levels[alertLevel].icon);
        }

        $body.empty().append(message);
        $alert.addClass(`${alertLevel} show`).alert();
    }

    function onSubmit() {
        const $input = $("#size_input");
        const action = "@Model.Action";
        let value = $input.val();

        $input.val(value.replace(/\./g, ","));

        if (actions[action]) {
            sessionStorage.setItem(actions[action], "1");
        }
    }

    // check validation for DSD formats
    function checkValidData(isNew = false) {
        const suffix = isNew ? "_modal" : "";
        const codec = $(`#digitalformat_input${suffix}`).val()?.toLowerCase();
        const bitness = $(`#bitness_input${suffix}`).val();
        let sampling = $(`#sampling_input${suffix}`).val()?.replace(",", ".");

        if (!codec || !bitness || !sampling)
            return;

        const alertId = `digitization_warning${suffix}`;

        if (dsdFormats[codec]) {
        if (bitness !== "1") {
            showAlert(alertId, "alert-warning", "DSD is 1 bit/s format");
        }
        else if (sampling !== dsdFormats[codec]) {
            showAlert(alertId, "alert-warning", `${codec.toUpperCase()} sampling is ${dsdFormats[codec]} (MHz)`);
        }
        else {
            $(`#${alertId}`).removeClass("show");
        }
    }
    }

    function checkAlbumIsExists(isNew = false) {
        currentAlbumCheckContext = isNew ? "modal" : "main";
        let albumId = Number($("#albumid").val());
        let album = $("#album_input").val();
        let artist = $("#artist_input").val();
        let source = $(`#source_input${isNew ? "_modal" : ""}`).val();
        if (albumId && album && artist) {
            checkAlbum(albumId, album, artist, source);
        }
    }

    async function checkAlbum(albumId, album, artist, source) {
        try {
            await connection.invoke("CheckAlbum", connection.connectionId, albumId, album, artist, source);
        } catch (err) {
            console.error("Error checking album:", err);
        }
    }

    connection.on("ReceivedManufacturer", (category, result) => {
        
        const categoryFieldMap = {
            "player": "player",
            "cartridge": "cartridge",
            "amplifier": "amp",
            "adc": "adc",
            "wire": "wire"
        };
        
        const fieldPrefix = categoryFieldMap[category.toLowerCase()];
        if (fieldPrefix) {
            $(`#${fieldPrefix}_manufacturer_input`).val(result || "");
        }
    });

    connection.on("AlbumIsExist", (factor, albumId) => {
        const message = alertMessages[factor];
        if (!message) return;

        const text = typeof message.text === "function"
            ? message.text(albumId)
            : message.text;

        const alertId = currentAlbumCheckContext === "modal"
            ? "digitization_warning_modal"
            : "digitization_warning";

        showAlert(alertId, `alert-${message.type}`, text);
    });

    connection.on("DigitizationAdded", (success, message, albumId, digitizations) => {
        $("#loader").hide();
        if (success) {
            if (albumId > 0 && $("#albumid").val() == "0") {
                $("#albumid").val(albumId);
            }
            renderDigitizations(digitizations);
            clearDigitizationFields();
            showToast("toast_digitization_added");
        } else {
            showToast("toast_digitization_error", "Error: " + message);
        }
    });

    connection.on("DigitizationUpdated", (success, message, digitizations) => {
        $("#loader").hide();
        if (success) {
            renderDigitizations(digitizations);
            clearDigitizationFields();
            showToast("toast_digitization_updated");
        } else {
            showToast("toast_digitization_error", "Error: " + message);
        }
    });

    connection.on("DigitizationRemoved", (success, message, digitizations) => {
        $("#loader").hide();
        if (success) {
            renderDigitizations(digitizations);
            clearDigitizationFields();
            showToast("toast_digitization_removed");
        } else {
            showToast("toast_digitization_error", "Error: " + message);
        }
    });

    Dropzone.autoDiscover = false;
    let myDropzone = new Dropzone("div#mydropzone",
    {
        url: "/uploadimage",
        addRemoveLinks: true,
        thumbnailWidth: 300,
        thumbnailHeight: 300,
        resizeWidth: 300,
        resizeHeight: 300,
        dictDefaultMessage: "<b>Upload album cover</b><br><i>Images > 300x300 pixels will be resized</i>",
        acceptedFiles: ".jpeg,.png,.jpg",
            success: (file, data) => {
                $("#coverid").val(data.filename);
                let preview = $(file.previewElement);
                preview.addClass("dz-success text-success");
            },
            init: function() {
                const coverId = $("#coverid").val();
                const albumId = $("#albumid").val();
                if (coverId !== "" && !coverId.includes("nocover")) {
                    let myDropzone = this;
                    let coverUrl;
                    if (window.location.href.includes("edit") && albumId) {
                        // When editing, construct the proper image URL
                        coverUrl = `/covers/album/${albumId}.jpg`;
                    } else {
                        // When creating, use temp path
                        coverUrl = `/temp/${coverId}`;
                    }
                    // Use a mock file object with a name to avoid "undefined" display
                    const mockFile = { name: "cover.jpg", size: 0, type: "image/jpeg" };
                    myDropzone.displayExistingFile(mockFile, coverUrl);
                }
            },
            removedfile: function(file) {
                $("#coverid").val("");
                if (file.previewElement != null && file.previewElement.parentNode != null) {
                    file.previewElement.parentNode.removeChild(file.previewElement);
                }
                return this._updateMaxFilesReachedClass();
            }
    });
</script>