@model AlbumCreateUpdateViewModel;

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toast-digitization-added" class="toast toast-body-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">Digitization added successfully</div>
    </div>
    <div id="toast-digitization-updated" class="toast toast-body-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">Digitization updated successfully</div>
    </div>
    <div id="toast-digitization-removed" class="toast toast-body-success" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">Digitization removed successfully</div>
    </div>
</div>
<a class="btn btn-outline-secondary mt-3" asp-action="Index" asp-controller="Album">
    <i class="fa-solid fa-arrow-left"></i> Back
</a>
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>@(Model.Action == Web.Enums.ActionType.Create ? "Add New Album" : "Edit Album")</h3>
    </div>
    <form asp-action="@Model.Action" method="post" onsubmit="onSubmit()">
        <input type="hidden" id="cover-id" asp-for="AlbumCover" />
        <input type="hidden" id="album-id" asp-for="AlbumId" />
        <input type="hidden" id="action" asp-for="Action" />
        <div class="card shadow-sm border-1 p-3">
            <div class="row align-items-stretch">
                <div class="col-auto d-flex">
                    <div id="mydropzone" class="dropzone"></div>
                </div>
                <div class="col d-flex flex-column">
                    <ul class="nav nav-tabs" id="mainAlbumTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                General
                            </button>
                        </li>
                        <li class="nav-item digitization-dependent-tab d-none" role="presentation">
                            <button class="nav-link" id="digitization-tab" data-bs-toggle="tab" data-bs-target="#digitization" type="button" role="tab">
                                Digitization
                            </button>
                        </li>
                        <li class="nav-item digitization-dependent-tab d-none" role="presentation">
                            <button class="nav-link" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardware" type="button" role="tab">
                                Hardware
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content border border-top-0 rounded-bottom p-3 bg-light" id="albumTabsContent">
                        <div class="tab-pane fade show active" id="general" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <input id="artist-input" class="form-control" asp-for="Artist" placeholder="Artist" oninput=checkAlbumIsExists(false) />
                                </div>
                                <div class="col-md-12">
                                    <input id="album-input" class="form-control" asp-for="Title" placeholder="Album" oninput=checkAlbumIsExists(false) />
                                </div>
                                <div class="col-md-12">
                                    <input id="genre-input" class="form-control" asp-for="Genre" placeholder="Genre" />
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="digitization" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <input id="vinylstate-input" class="form-control" asp-for="VinylState" placeholder="Vinyl state" />
                                </div>
                                <div class="col-md-4">
                                    <input id="digitalformat-input" class="form-control" asp-for="DigitalFormat" placeholder="Digital format" onchange="checkValidData()" />
                                </div>
                                <div class="col-md-4">
                                    <input id="bitness-input" class="form-control" asp-for="Bitness" placeholder="Bitness" onchange="checkValidData()" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sampling-input" class="form-control" asp-for="Sampling" placeholder="Sampling" onchange="checkValidData()" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sourceformat-input" class="form-control" asp-for="SourceFormat" placeholder="Source format" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Storage" placeholder="Storage" />
                                </div>
                                <div class="col-md-4">
                                    <input id="year-input" class="form-control" asp-for="Year" placeholder="Year" />
                                </div>
                                <div class="col-md-4">
                                    <input id="reissue-input" class="form-control" asp-for="Reissue" placeholder="Reissue" />
                                </div>
                                <div class="col-md-4">
                                    <input id="country-input" class="form-control" asp-for="Country" placeholder="Country" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Label" placeholder="Label" />
                                </div>
                                <div class="col-md-8">
                                    <input id="source-input" class="form-control" asp-for="Source" placeholder="Source" oninput="checkAlbumIsExists(false)" />
                                </div>
                                <div class="col-md-8">
                                    <input class="form-control" asp-for="Discogs" placeholder="Discogs link" />
                                </div>
                                <div class="col-md-4">
                                    <input id="size-input" class="form-control" asp-for="Size" placeholder="Size (GB)" />
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="hardware" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6"><input id="player-input" class="form-control" asp-for="Player" placeholder="Player" /></div>
                                <div class="col-md-6"><input id="player-manufacturer-input" class="form-control" asp-for="PlayerManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="cartridge-input" class="form-control" asp-for="Cartridge" placeholder="Cartridge" /></div>
                                <div class="col-md-6"><input id="cartridge-manufacturer-input" class="form-control" asp-for="CartridgeManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="amp-input" class="form-control" asp-for="Amplifier" placeholder="Amplifier" /></div>
                                <div class="col-md-6"><input id="amp-manufacturer-input" class="form-control" asp-for="AmplifierManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="adc-input" class="form-control" asp-for="Adc" placeholder="ADC" /></div>
                                <div class="col-md-6"><input id="adc-manufacturer-input" class="form-control" asp-for="AdcManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="wire-input" class="form-control" asp-for="Wire" placeholder="Wire" /></div>
                                <div class="col-md-6"><input id="wire-manufacturer-input" class="form-control" asp-for="WireManufacturer" placeholder="Manufacturer" /></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end align-items-center gap-2 mt-4">
                <div id="digitization-warning" class="alert alert-danger alert-dismissible fade m-0 py-1 px-3 d-flex align-items-center justify-content-center flex-grow-1"
                     role="alert"
                     style="white-space: nowrap; min-height: 38px;">
                    <span id="album-check-spinner" class="spinner-border spinner-border-sm album-check-spinner d-none me-2" role="status" style="width: 1.25rem; height: 1.25rem;" aria-label="Checking album..."></span>
                    <i id="alert-icon" class="me-2"></i>&nbsp
                    <span class="alert-message"></span>
                </div>
                <button id="add-digitization-btn" class="btn btn-info px-4" onclick="ShowAddModal()" type="button" disabled>
                    <i class="fa-solid fa-plus"></i> Add
                </button>
                <button id="update-digitization-btn" class="btn btn-warning px-4" onclick="UpdateDigitization()" type="button" disabled>
                    <i class="fa-regular fa-pen-to-square"></i> Update
                </button>
                <button id="remove-digitization-btn" class="btn btn-danger px-4" onclick="ShowRemoveModal()" type="button" disabled>
                    <i class="fa-solid fa-xmark"></i> Remove
                </button>
                <button id="save-album-btn" type="submit" class="btn btn-success px-4">
                    <i class="fa-solid fa-check"></i> Save
                </button>
            </div>
        </div>
    </form>
    <br />
    </div>
    <div class="position-relative shadow-sm border-1 p-3">
        <div class="album-create-update-overlay" id="loader">
            <div class="spinner-border" role="status"></div>
        </div>
        <div id="digitizations-container">
            <div class="album-create-update-no-digitizations" id="no-digitizations">No digitizations</div>
        </div>
    </div>
    <div class="modal fade" id="removeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Removal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to remove this digitization? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="RemoveDigitization()">Remove</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addDigitizationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add new digitization</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card shadow-sm border-1 p-3">
            <div class="row align-items-stretch">
                <div class="col d-flex flex-column">
                    <ul class="nav nav-tabs" id="albumTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="digitization-tab" data-bs-toggle="tab" data-bs-target="#digitizationModal" type="button" role="tab">
                                Digitization
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardwareModal" type="button" role="tab">
                                Hardware
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content border border-top-0 rounded-bottom p-3 bg-light" id="albumTabsContentModal">
                        <div class="tab-pane fade show active" id="digitizationModal" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <input id="vinylstate-input-modal" class="form-control" asp-for="VinylState" placeholder="Vinyl state" />
                                </div>
                                <div class="col-md-4">
                                    <input id="digitalformat-input-modal" class="form-control" asp-for="DigitalFormat" placeholder="Digital format" onchange="checkValidData(true)" />
                                </div>
                                <div class="col-md-4">
                                    <input id="bitness-input-modal" class="form-control" asp-for="Bitness" placeholder="Bitness" onchange="checkValidData(true)" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sampling-input-modal" class="form-control" asp-for="Sampling" placeholder="Sampling" onchange="checkValidData(true)" />
                                </div>
                                <div class="col-md-4">
                                    <input id="sourceformat-input-modal" class="form-control" asp-for="SourceFormat" placeholder="Source format" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Storage" placeholder="Storage" />
                                </div>
                                <div class="col-md-4">
                                    <input id="year-input-modal" class="form-control" asp-for="Year" placeholder="Year" />
                                </div>
                                <div class="col-md-4">
                                    <input id="reissue-input-modal" class="form-control" asp-for="Reissue" placeholder="Reissue" />
                                </div>
                                <div class="col-md-4">
                                    <input id="country-input-modal" class="form-control" asp-for="Country" placeholder="Country" />
                                </div>
                                <div class="col-md-4">
                                    <input class="form-control" asp-for="Label" placeholder="Label" />
                                </div>
                                <div class="col-md-8">
                                    <input id="source-input-modal" class="form-control" asp-for="Source" placeholder="Source" oninput="checkAlbumIsExists(true)" />
                                </div>
                                <div class="col-md-8">
                                    <input class="form-control" asp-for="Discogs" placeholder="Discogs link" />
                                </div>
                                <div class="col-md-4">
                                    <input id="size-input-modal" class="form-control" asp-for="Size" placeholder="Size (GB)" />
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="hardwareModal" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6"><input id="player-input-modal" class="form-control" asp-for="Player" placeholder="Player" /></div>
                                <div class="col-md-6"><input id="player-manufacturer-input-modal" class="form-control" asp-for="PlayerManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="cartridge-input-modal" class="form-control" asp-for="Cartridge" placeholder="Cartridge" /></div>
                                <div class="col-md-6"><input id="cartridge-manufacturer-input-modal" class="form-control" asp-for="CartridgeManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="amp-input-modal" class="form-control" asp-for="Amplifier" placeholder="Amplifier" /></div>
                                <div class="col-md-6"><input id="amp-manufacturer-input-modal" class="form-control" asp-for="AmplifierManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="adc-input-modal" class="form-control" asp-for="Adc" placeholder="ADC" /></div>
                                <div class="col-md-6"><input id="adc-manufacturer-input-modal" class="form-control" asp-for="AdcManufacturer" placeholder="Manufacturer" /></div>
                                <div class="col-md-6"><input id="wire-input-modal" class="form-control" asp-for="Wire" placeholder="Wire" /></div>
                                <div class="col-md-6"><input id="wire-manufacturer-input-modal" class="form-control" asp-for="WireManufacturer" placeholder="Manufacturer" /></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
                <div class="modal-footer">
                    <div id="digitization-warning-modal" class="alert alert-danger alert-dismissible fade m-0 py-1 px-3 d-flex align-items-center justify-content-center flex-grow-1" role="alert" style="white-space: nowrap; min-height: 38px;">
                        <span id="album-check-spinner-modal" class="spinner-border spinner-border-sm album-check-spinner d-none me-2" role="status" style="width: 1.25rem; height: 1.25rem;" aria-label="Checking album..."></span>
                        <i id="alert-icon-modal" class="me-2"></i>&nbsp
                        <span class="alert-message"></span>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="AddDigitization()">Add</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // --- State ---
    let selectedDigitizationId = 0;
    let digitizations = [];
    let currentAlbumCheckContext = "main";

    // --- Constants / config ---
    const alertMessages = {
        0: { type: "success", text: "No duplicates found." },
        1: { type: "danger", text: (id) => `${prepareAlbumLink(id)} already exists.` },
        50: { type: "warning", text: "Digitization already exists. Please check to make sure this is not a duplicate." },
        100: { type: "danger", text: "Digitization already exists with that source." }
    };
    const levels = {
        "alert-success": { icon: "fa-solid fa-circle-check" },
        "alert-warning": { icon: "fa-solid fa-circle-exclamation" },
        "alert-danger": { icon: "fa-solid fa-triangle-exclamation" }
    };
    const actions = { "Create": "albumcreated", "Update": "albumupdated" };
    const dsdFormats = { dsd64: "2.8", dsd128: "5.6", dsd256: "11.2", dsd512: "22.5" };
    const fieldEntityMap = {
        "artist-input": "Artist", "genre-input": "Genre", "vinylstate-input": "VinylState",
        "digitalformat-input": "DigitalFormat", "bitness-input": "Bitness", "sampling-input": "Sampling",
        "sourceformat-input": "SourceFormat", "year-input": "Year", "reissue-input": "Reissue",
        "player-input": "Player", "cartridge-input": "Cartridge", "amp-input": "Amplifier",
        "adc-input": "Adc", "wire-input": "Wire", "country-input": "Country",
        "label-input": "Label", "storage-input": "Storage"
    };
    const equipmentManufacturerMap = {
        "player-input": "PlayerManufacturer", "cartridge-input": "CartridgeManufacturer",
        "amp-input": "AmplifierManufacturer", "adc-input": "AdcManufacturer", "wire-input": "WireManufacturer"
    };

    // --- Utilities ---
    function showToast(toastId, message = null) {
        const $toastEl = $('#' + toastId);
        if ($toastEl.length) {
            if (message) {
                const $msgEl = $toastEl.find('.toast-body, #' + toastId + '_msg');
                if ($msgEl.length) $msgEl.text(message);
            }
            new bootstrap.Toast($toastEl[0]).show();
        }
    }

    function prepareAlbumLink(id) {
        return id ? `<a href="/album/${id}" target="_blank" class="alert-link">Album</a>` : "";
    }

    function showAlert(alertId, alertLevel, message) {
        const $alert = $(`#${alertId}`);
        const $icon = $alert.find("i");
        const $body = $alert.find("span.alert-message");
        $alert.find(".album-check-spinner").addClass("d-none");
        $alert.removeClass((_, cls) => (cls.match(/alert-\S+/g) || []).join(" "));
        $icon.removeClass().show();
        if (levels[alertLevel]) $icon.addClass(levels[alertLevel].icon);
        $body.empty().append(message);
        $alert.addClass(`${alertLevel} show`).alert();
    }

    function showCheckingAlert(alertId) {
        const $alert = $(`#${alertId}`);
        const $icon = $alert.find("i");
        const $body = $alert.find("span.alert-message");
        $alert.find(".album-check-spinner").removeClass("d-none");
        $icon.hide();
        $alert.removeClass((_, cls) => (cls.match(/alert-\S+/g) || []).join(" "));
        $body.empty().append("No duplicates found.");
        $alert.addClass("alert-secondary show").alert();
    }

    // --- UI state & button visibility ---
    function checkAddButtonState() {
        const artist = $("#artist-input").val()?.trim();
        const album = $("#album-input").val()?.trim();
        const genre = $("#genre-input").val()?.trim();
        const hasRequiredFields = artist && album && genre;
        $("#add-digitization-btn").prop("disabled", !hasRequiredFields);
    }

    function checkUpdateRemoveButtons() {
        const enabled = selectedDigitizationId > 0;
        $("#update-digitization-btn").prop("disabled", !enabled);
        $("#remove-digitization-btn").prop("disabled", !enabled);
    }

    function updateDigitizationHardwareTabsVisibility() {
        const show = selectedDigitizationId > 0;
        const $dependentTabs = $("#mainAlbumTabs .digitization-dependent-tab");
        if (show) {
            $dependentTabs.removeClass("d-none");
        } else {
            $dependentTabs.addClass("d-none");
            const generalTabEl = document.getElementById("general-tab");
            if (generalTabEl) {
                bootstrap.Tab.getOrCreateInstance(generalTabEl).show();
            }
        }
    }

    // --- Digitization: form & CRUD ---
    function clearDigitizationFields() {
        $("#vinylstate-input, #digitalformat-input, #bitness-input, #sampling-input, #sourceformat-input").val("");
        $("#year-input, #reissue-input").val("");
        $("#source-input, #size-input").val("");
        $("#player-input, #cartridge-input, #amp-input, #adc-input, #wire-input").val("");
        $("#player-manufacturer-input, #cartridge-manufacturer-input, #amp-manufacturer-input, #adc-manufacturer-input, #wire-manufacturer-input").val("");
        $("input[placeholder='Country']").val("");
        $("input[placeholder='Label']").val("");
        $("input[placeholder='Storage']").val("");
        $("input[placeholder='Discogs link']").val("");
        selectedDigitizationId = 0;
        checkUpdateRemoveButtons();
        updateDigitizationHardwareTabsVisibility();
    }

    function loadDigitizationToFields(digitization) {
        selectedDigitizationId = digitization.id || digitization.Id;
        // Format Info - handle both camelCase and PascalCase (use ?? so 0 is shown)
        $("#vinylstate-input").val(digitization.vinylState || digitization.VinylState || "");
        $("#digitalformat-input").val(digitization.digitalFormat || digitization.DigitalFormat || "");
        $("#bitness-input").val(digitization.bitness != null ? digitization.bitness : (digitization.Bitness != null ? digitization.Bitness : ""));
        $("#sampling-input").val(digitization.sampling != null ? digitization.sampling : (digitization.Sampling != null ? digitization.Sampling : ""));
        $("#sourceformat-input").val(digitization.sourceFormat || digitization.SourceFormat || "");
        $("#size-input").val(digitization.size != null ? digitization.size : (digitization.Size != null ? digitization.Size : ""));
        
        // Equipment Info - handle both camelCase and PascalCase
        const playerManufacturer = digitization.playerManufacturer || digitization.PlayerManufacturer || "";
        const cartridgeManufacturer = digitization.cartridgeManufacturer || digitization.CartridgeManufacturer || "";
        const amplifierManufacturer = digitization.amplifierManufacturer || digitization.AmplifierManufacturer || "";
        const adcManufacturer = digitization.adcManufacturer || digitization.AdcManufacturer || "";
        const wireManufacturer = digitization.wireManufacturer || digitization.WireManufacturer || "";
        
        // Set equipment names
        $("#player-input").val(digitization.player || digitization.Player || "");
        $("#cartridge-input").val(digitization.cartridge || digitization.Cartridge || "");
        $("#amp-input").val(digitization.amplifier || digitization.Amplifier || "");
        $("#adc-input").val(digitization.adc || digitization.Adc || "");
        $("#wire-input").val(digitization.wire || digitization.Wire || "");
        
        // Set manufacturer fields
        $("#player-manufacturer-input").val(playerManufacturer);
        $("#cartridge-manufacturer-input").val(cartridgeManufacturer);
        $("#amp-manufacturer-input").val(amplifierManufacturer);
        $("#adc-manufacturer-input").val(adcManufacturer);
        $("#wire-manufacturer-input").val(wireManufacturer);
        
        // Other fields - handle both camelCase and PascalCase
        $("#year-input").val(digitization.year || digitization.Year || "");
        $("#reissue-input").val(digitization.reissue || digitization.Reissue || "");
        
        // Country, Label, Storage, Discogs
        $("input[placeholder='Country']").val(digitization.country || digitization.Country || "");
        $("input[placeholder='Label']").val(digitization.label || digitization.Label || "");
        $("input[placeholder='Storage']").val(digitization.storage || digitization.Storage || "");
        $("input[placeholder='Discogs link']").val(digitization.discogs || digitization.Discogs || "");
        $("#source-input").val(digitization.source || digitization.Source || "");

        checkUpdateRemoveButtons();
        updateDigitizationHardwareTabsVisibility();
    }

    function renderDigitizations(digs) {
        digitizations = digs || [];
        const $container = $("#digitizations-container");
        $container.empty();
        
        if (!digs || digs.length === 0) {
            $container.html('<div class="album-create-update-no-digitizations" id="no-digitizations">No digitizations</div>');
            selectedDigitizationId = 0;
            checkUpdateRemoveButtons();
            updateDigitizationHardwareTabsVisibility();
            $("#loader").hide();
            return;
        }
        
        const $table = $(`
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">VS</th>
                        <th scope="col">BTS</th>
                        <th scope="col">SMP</th>
                        <th scope="col">FMT</th>
                        <th scope="col">SRC</th>
                        <th scope="col">PLR</th>
                        <th scope="col">CRT</th>
                        <th scope="col">AMP</th>
                        <th scope="col">ADC</th>
                        <th scope="col">WIR</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        `);
        
        const $tbody = $table.find("tbody");
        
        digs.forEach(dig => {
            const digId = dig.id || dig.Id;
            const $row = $(`
                <tr class="digitization-row ${selectedDigitizationId === digId ? 'table-active' : ''}" data-id="${digId}" style="cursor: pointer;">
                    <td>${dig.vinylState || dig.VinylState || '-'}</td>
                    <td>${(dig.bitness || dig.Bitness) ? (dig.bitness || dig.Bitness) + 'bit' : '-'}</td>
                    <td>${dig.sampling || dig.Sampling || '-'}</td>
                    <td>${dig.digitalFormat || dig.DigitalFormat || '-'}</td>
                    <td>${dig.source || dig.Source || '-'}</td>
                    <td>${dig.player || dig.Player || '-'}</td>
                    <td>${dig.cartridge || dig.Cartridge || '-'}</td>
                    <td>${dig.amplifier || dig.Amplifier || '-'}</td>
                    <td>${dig.adc || dig.Adc || '-'}</td>
                    <td>${dig.wire || dig.Wire || '-'}</td>
                </tr>
            `);
            
            $row.on("click", function() {
                $(".digitization-row").removeClass("table-active");
                $(this).addClass("table-active");
                const clickedDigId = $(this).data("id");
                const clickedDig = digitizations.find(d => (d.id === clickedDigId) || (d.Id === clickedDigId));
                if (clickedDig) {
                    loadDigitizationToFields(clickedDig);
                }
            });
            
            $tbody.append($row);
        });
        
        $container.append($table);
        $("#loader").hide();
    }

    async function AddDigitization() {
        const $modal = $("#addDigitizationModal");
        const req = {
            albumId: Number($("#album-id").val()) || 0,
            digitizationId: 0,
            artist: $("#artist-input").val()?.trim() || "",
            album: $("#album-input").val()?.trim() || "",
            genre: $("#genre-input").val()?.trim() || "",
            source: $modal.find("#source-input-modal").val()?.trim() || null,
            discogs: $modal.find("input[placeholder='Discogs link']").val()?.trim() || null,
            isFirstPress: false,
            country: $modal.find("#country-input-modal").val()?.trim() || null,
            label: $modal.find("input[placeholder='Label']").val()?.trim() || null,
            storage: $modal.find("input[placeholder='Storage']").val()?.trim() || null,
            year: $modal.find("#year-input-modal").val() ? Number($modal.find("#year-input-modal").val()) : null,
            reissue: $modal.find("#reissue-input-modal").val() ? Number($modal.find("#reissue-input-modal").val()) : null,
            size: $modal.find("#size-input-modal").val() ? parseFloat($modal.find("#size-input-modal").val().replace(",", ".")) : null,
            vinylState: $modal.find("#vinylstate-input-modal").val()?.trim() || null,
            digitalFormat: $modal.find("#digitalformat-input-modal").val()?.trim() || null,
            bitness: $modal.find("#bitness-input-modal").val() ? Number($modal.find("#bitness-input-modal").val()) : null,
            sampling: $modal.find("#sampling-input-modal").val() ? parseFloat($modal.find("#sampling-input-modal").val().replace(",", ".")) : null,
            sourceFormat: $modal.find("#sourceformat-input-modal").val()?.trim() || null,
            player: $modal.find("#player-input-modal").val()?.trim() || null,
            playerManufacturer: $modal.find("#player-manufacturer-input-modal").val()?.trim() || null,
            cartridge: $modal.find("#cartridge-input-modal").val()?.trim() || null,
            cartridgeManufacturer: $modal.find("#cartridge-manufacturer-input-modal").val()?.trim() || null,
            amplifier: $modal.find("#amp-input-modal").val()?.trim() || null,
            amplifierManufacturer: $modal.find("#amp-manufacturer-input-modal").val()?.trim() || null,
            adc: $modal.find("#adc-input-modal").val()?.trim() || null,
            adcManufacturer: $modal.find("#adc-manufacturer-input-modal").val()?.trim() || null,
            wire: $modal.find("#wire-input-modal").val()?.trim() || null,
            wireManufacturer: $modal.find("#wire-manufacturer-input-modal").val()?.trim() || null
        };
        
        $("#loader").show();
        try {
            await connection.invoke("AddDigitization", connection.connectionId, req);
        } catch (err) {
            console.error("Error adding digitization:", err);
            $("#loader").hide();
            showToast("toast-digitization-error", "Error adding digitization: " + err.message);
        }
    }

    async function UpdateDigitization() {
        if (selectedDigitizationId === 0) {
            showToast("toast-digitization-warning", "Please select a digitization to update");
            return;
        }
        
        const req = {
            albumId: Number($("#album-id").val()) || 0,
            digitizationId: selectedDigitizationId,
            artist: $("#artist-input").val()?.trim() || "",
            album: $("#album-input").val()?.trim() || "",
            genre: $("#genre-input").val()?.trim() || "",
            source: $("#source-input").val()?.trim() || null,
            discogs: $("input[placeholder='Discogs link']").val()?.trim() || null,
            isFirstPress: false,
            country: $("input[placeholder='Country']").val()?.trim() || null,
            label: $("input[placeholder='Label']").val()?.trim() || null,
            storage: $("input[placeholder='Storage']").val()?.trim() || null,
            year: $("#year-input").val() ? Number($("#year-input").val()) : null,
            reissue: $("#reissue-input").val() ? Number($("#reissue-input").val()) : null,
            size: $("#size-input").val() ? parseFloat($("#size-input").val().replace(",", ".")) : null,
            vinylState: $("#vinylstate-input").val()?.trim() || null,
            digitalFormat: $("#digitalformat-input").val()?.trim() || null,
            bitness: $("#bitness-input").val() ? Number($("#bitness-input").val()) : null,
            sampling: $("#sampling-input").val() ? parseFloat($("#sampling-input").val().replace(",", ".")) : null,
            sourceFormat: $("#sourceformat-input").val()?.trim() || null,
            player: $("#player-input").val()?.trim() || null,
            playerManufacturer: $("#player-manufacturer-input").val()?.trim() || null,
            cartridge: $("#cartridge-input").val()?.trim() || null,
            cartridgeManufacturer: $("#cartridge-manufacturer-input").val()?.trim() || null,
            amplifier: $("#amp-input").val()?.trim() || null,
            amplifierManufacturer: $("#amp-manufacturer-input").val()?.trim() || null,
            adc: $("#adc-input").val()?.trim() || null,
            adcManufacturer: $("#adc-manufacturer-input").val()?.trim() || null,
            wire: $("#wire-input").val()?.trim() || null,
            wireManufacturer: $("#wire-manufacturer-input").val()?.trim() || null
        };
        
        $("#loader").show();
        try {
            await connection.invoke("UpdateDigitization", connection.connectionId, req);
        } catch (err) {
            console.error("Error updating digitization:", err);
            $("#loader").hide();
            showToast("toast-digitization-error", "Error updating digitization: " + err.message);
        }
    }

    function ShowAddModal() {
        const modal = new bootstrap.Modal(document.getElementById("addDigitizationModal"));
        modal.show();
    }

    function ShowRemoveModal() {
        if (selectedDigitizationId === 0) {
            showToast("toast-digitization-warning", "Please select a digitization to remove");
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById("removeModal"));
        modal.show();
    }

    async function RemoveDigitization() {
        if (selectedDigitizationId === 0) return;
        
        $("#loader").show();
        const modal = bootstrap.Modal.getInstance(document.getElementById("removeModal"));
        modal.hide();
        
        try {
            await connection.invoke("RemoveDigitization", connection.connectionId, selectedDigitizationId);
        } catch (err) {
            console.error("Error removing digitization:", err);
            $("#loader").hide();
            showToast("toast-digitization-error", "Error removing digitization: " + err.message);
        }
    }

    // --- Validation ---
    function checkValidData(isNew = false) {
        const idSuffix = isNew ? "-modal" : "";
        const codec = $(`#digitalformat-input${idSuffix}`).val()?.toLowerCase();
        const bitness = $(`#bitness-input${idSuffix}`).val();
        let sampling = $(`#sampling-input${idSuffix}`).val()?.replace(",", ".");
        if (!codec || !bitness || !sampling) return;
        const alertId = `digitization-warning${idSuffix}`;
        if (dsdFormats[codec]) {
            if (bitness !== "1") {
                showAlert(alertId, "alert-warning", "DSD is 1 bit/s format");
            } else if (sampling !== dsdFormats[codec]) {
                showAlert(alertId, "alert-warning", `${codec.toUpperCase()} sampling is ${dsdFormats[codec]} (MHz)`);
            } else {
                $(`#${alertId}`).removeClass("show");
            }
        }
    }

    function checkAlbumIsExists(isNew = false) {
        currentAlbumCheckContext = isNew ? "modal" : "main";
        let albumId = Number($("#album-id").val());
        let album = $("#album-input").val();
        let artist = $("#artist-input").val();
        let source = $(`#source-input${isNew ? "-modal" : ""}`).val();
        const alertId = isNew ? "digitization-warning-modal" : "digitization-warning";
        if (albumId && album && artist) {
            checkAlbum(albumId, album, artist, source, alertId);
        } else {
            $(`#${alertId} .album-check-spinner`).addClass("d-none");
        }
    }

    async function checkAlbum(albumId, album, artist, source, alertId) {
        try {
            showCheckingAlert(alertId);
            await connection.invoke("CheckAlbum", connection.connectionId, albumId, album, artist, source);
        } catch (err) {
            console.error("Error checking album:", err);
            $(`#${alertId} .album-check-spinner`).addClass("d-none");
        }
    }

    function onSubmit() {
        const $input = $("#size-input");
        const action = "@Model.Action";
        let value = $input.val();
        $input.val(value.replace(/\./g, ","));
        if (actions[action]) sessionStorage.setItem(actions[action], "1");
    }

    // --- Autocomplete & manufacturer ---
    async function getManufacturer(manufacturerType, equipmentValue) {
        if (!manufacturerType || !equipmentValue) return;
        try {
            const categoryMap = {
                "PlayerManufacturer": "player", "CartridgeManufacturer": "cartridge",
                "AmplifierManufacturer": "amplifier", "AdcManufacturer": "adc", "WireManufacturer": "wire"
            };
            const category = categoryMap[manufacturerType];
            if (category) {
                await connection.invoke("GetManufacturer", connection.connectionId, category, equipmentValue);
            }
        } catch (err) {
            console.error("Error getting manufacturer:", err);
        }
    }

    // --- SignalR handlers ---
    connection.on("ReceivedManufacturer", (category, result) => {
        if (window._lastManufacturerTargetId) {
            $(`#${window._lastManufacturerTargetId}`).val(result || "");
            window._lastManufacturerTargetId = null;
            return;
        }
        const categoryFieldMap = { "player": "player", "cartridge": "cartridge", "amplifier": "amp", "adc": "adc", "wire": "wire" };
        const fieldPrefix = categoryFieldMap[category.toLowerCase()];
        if (fieldPrefix) $(`#${fieldPrefix}-manufacturer-input`).val(result || "");
    });

    connection.on("AlbumIsExist", (factor, albumId) => {
        const alertId = currentAlbumCheckContext === "modal" ? "digitization-warning-modal" : "digitization-warning";
        $(`#${alertId} .album-check-spinner`).addClass("d-none");
        const message = alertMessages[factor];
        if (!message) return;
        const text = typeof message.text === "function" ? message.text(albumId) : message.text;
        showAlert(alertId, `alert-${message.type}`, text);
        const isDuplicate = factor === 1 || factor === 100;
        $("#save-album-btn").prop("disabled", isDuplicate);
        $("#add-digitization-btn").prop("disabled", isDuplicate);
        if (!isDuplicate) checkAddButtonState();
    });

    connection.on("DigitizationAdded", (success, message, albumId, digitizations) => {
        $("#loader").hide();
        if (success) {
            if (albumId > 0 && $("#album-id").val() == "0") $("#album-id").val(albumId);
            renderDigitizations(digitizations);
            clearDigitizationFields();
            showToast("toast-digitization-added");
        } else {
            showToast("toast-digitization-error", "Error: " + message);
        }
    });

    connection.on("DigitizationUpdated", (success, message, digitizations) => {
        $("#loader").hide();
        if (success) {
            renderDigitizations(digitizations);
            clearDigitizationFields();
            showToast("toast-digitization-updated");
        } else {
            showToast("toast-digitization-error", "Error: " + message);
        }
    });

    connection.on("DigitizationRemoved", (success, message, digitizations) => {
        $("#loader").hide();
        if (success) {
            renderDigitizations(digitizations);
            clearDigitizationFields();
            showToast("toast-digitization-removed");
        } else {
            showToast("toast-digitization-error", "Error: " + message);
        }
    });

    connection.onclose(async () => { await start(); });

    // --- Dropzone ---
    Dropzone.autoDiscover = false;
    let myDropzone = new Dropzone("div#mydropzone", {
        url: "/uploadimage",
        addRemoveLinks: true,
        thumbnailWidth: 300,
        thumbnailHeight: 300,
        resizeWidth: 300,
        resizeHeight: 300,
        dictDefaultMessage: "<b>Upload album cover</b><br><i>Images > 300x300 pixels will be resized</i>",
        acceptedFiles: ".jpeg,.png,.jpg",
        success: (file, data) => {
            $("#cover-id").val(data.filename);
            $(file.previewElement).addClass("dz-success text-success");
        },
        init: function () {
            const coverId = $("#cover-id").val();
            const albumId = $("#album-id").val();
            if (coverId !== "" && !coverId.includes("nocover")) {
            let myDropzone = this;
            let coverUrl = window.location.href.includes("edit") && albumId
                ? `/covers/album/${albumId}.jpg`
                : `/temp/${coverId}`;
            const mockFile = { name: "cover.jpg", size: 0, type: "image/jpeg" };
            myDropzone.displayExistingFile(mockFile, coverUrl);
            }
        },
        removedfile: function (file) {
            $("#cover-id").val("");
            if (file.previewElement?.parentNode) file.previewElement.parentNode.removeChild(file.previewElement);
            return this._updateMaxFilesReachedClass();
        }
    });

    // --- Init: document ready ---
    $(document).ready(async () => {
        await start();
        
        // Initialize button states
        checkAddButtonState();
        checkUpdateRemoveButtons();
        updateDigitizationHardwareTabsVisibility();
        
        // Set up field change listeners
        $("#artist-input, #album-input, #genre-input").on("input", checkAddButtonState);
        $("#vinylstate-input, #digitalformat-input, #bitness-input, #sampling-input, #sourceformat-input, #year-input, #reissue-input, #source-input, #size-input, #player-input, #cartridge-input, #amp-input, #adc-input, #wire-input").on("input", checkAddButtonState);
        
        // Load existing digitizations if any
        @if (Model.Digitizations?.Any() == true)
        {
            <text>
            const existingDigs = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Digitizations.Select(d => new {
                id = d.Id,
                vinylState = d.FormatInfo?.VinylState?.Name,
                bitness = d.FormatInfo?.Bitness?.Value,
                sampling = d.FormatInfo?.Sampling?.Value,
                digitalFormat = d.FormatInfo?.DigitalFormat?.Name,
                sourceFormat = d.FormatInfo?.SourceFormat?.Name,
                player = d.EquipmentInfo?.Player?.Name,
                playerManufacturer = d.EquipmentInfo?.Player?.Manufacturer?.Name ?? "",
                cartridge = d.EquipmentInfo?.Cartridge?.Name,
                cartridgeManufacturer = d.EquipmentInfo?.Cartridge?.Manufacturer?.Name ?? "",
                amplifier = d.EquipmentInfo?.Amplifier?.Name,
                amplifierManufacturer = d.EquipmentInfo?.Amplifier?.Manufacturer?.Name ?? "",
                adc = d.EquipmentInfo?.Adc?.Name,
                adcManufacturer = d.EquipmentInfo?.Adc?.Manufacturer?.Name ?? "",
                wire = d.EquipmentInfo?.Wire?.Name,
                wireManufacturer = d.EquipmentInfo?.Wire?.Manufacturer?.Name ?? "",
                source = d.Source,
                year = d.Year?.Value,
                reissue = d.Reissue?.Value,
                country = d.Country?.Name,
                label = d.Label?.Name,
                storage = d.Storage?.Data,
                discogs = d.Discogs,
                size = d.Size
            }), new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
            renderDigitizations(existingDigs);
            $("#loader").hide();
            </text>
        }
        else
        {
            <text>
            $("#loader").hide();
            </text>
        }
    });

    // --- Autocomplete init (DOM ready) ---
    $(() => {
        $("input:is([id$='-input'], [id$='-input-modal'])").each(function () {
            const $input = $(this);
            const fieldId = this.id;
            const baseId = fieldId.replace(/-modal$/, '');
            const entityType = fieldEntityMap[baseId];
            if (entityType) {
                const isModal = fieldId.includes('-modal');
                const autocompleteOpts = {
                    source: (request, response) => {
                        if (request.term.length < 2) { response([]); return; }
                        $.getJSON(`/search/${entityType}`, { value: request.term })
                            .done(function (data) {
                                const items = (data || []).map(item => {
                                    const label = item.label ?? item.Label ?? item.value ?? item.Value ?? '';
                                    const value = item.value ?? item.Value ?? item.label ?? item.Label ?? '';
                                    return { label, value };
                                });
                                response(items);
                            })
                            .fail(() => response([]));
                    },
                    delay: 300,
                    minLength: 2,
                    messages: { noResults: '', results: () => {} },
                    appendTo: isModal ? "#addDigitizationModal" : undefined,
                    select: function (event, ui) {
                        const manufacturerType = equipmentManufacturerMap[baseId];
                        if (manufacturerType) {
                            const manufacturerFieldId = fieldId.replace(/-input(-modal)?$/, (_, suffix) => '-manufacturer-input' + (suffix || ''));
                            window._lastManufacturerTargetId = manufacturerFieldId;
                            getManufacturer(manufacturerType, ui.item.value);
                        }
                    }
                };
                $input.autocomplete(autocompleteOpts);
            }
        });
    });
</script>