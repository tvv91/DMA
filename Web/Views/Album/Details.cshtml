@model AlbumDetailsViewModel

<script>
        function showToastFromStorage(key, toastId) {
        if (sessionStorage.getItem(key) === "1") {
            $(`#${toastId}`).toast("show");
            sessionStorage.removeItem(key);
        }
    }
    $(document).ready(async () => {
        await start();
        await getTechnicalInfoIcons(@Model.Album.Id);
        await getAlbumCover(@Model.Album.Id);

        showToastFromStorage("albumupdated", "toastinfo_updated");
        showToastFromStorage("albumcreated", "toastinfo_created");

        const backIndex = localStorage.getItem("BACK_PAGE_INDEX");
        if (backIndex && backIndex !== "1") {
            $("#back_button").attr("href", `/album?page=${backIndex}`);
        }
    })

    async function getTechnicalInfoIcons(albumId) {
        try {
            await connection.invoke("GetTechnicalInfoIcons", connection.connectionId, albumId);
        } catch (err) {
            console.log("Error sending request to GetTechnicalInfoIcons");
        }
    }

    async function getAlbumCover(albumId) {
        try {
            await connection.invoke("GetAlbumCover", connection.connectionId, albumId);
        } catch (err) {
            console.log("Error sending request to GetAlbumCover");
        }
    }

    connection.on("ReceivedTechnicalInfoIcon", (category, cover) => {
        const $spinner = $(`#${category}spinner`);
        const $img = $(`#${category}`);
        const $icon = $(`#${category}icon`);
        const $value = $(`#${category}`).closest(".tech-card").find(".value");
        const noCover = !cover || cover.toLowerCase().includes("nocover");
        const hasData = $value.text().trim() !== "No data";
    
        $spinner.hide();

        if (hasData) {
            if (noCover) {
                $img.hide();
                $icon.show();
            } else {
                $img.show().attr("src", cover);
                $icon.hide();
            }
        } else {
            $img.hide();
            $icon.hide();
        }
    });

        connection.on("ReceivedAlbumCoverDetailed", (cover) => {
        const $cover = $('#cover');
        const $spinnerOverlay = $('#coverSpinnerOverlay');
        const $noCover = $('#nocovericon');

        if (cover.includes("nocover")) {
            $noCover.show();
            $spinnerOverlay.addClass('hidden');
            $('#coverdiv').css("border", "solid");
        } else {
            $cover.attr("src", cover).show().on('load', () => {
                $cover.addClass('loaded'); // плавное появление
                $spinnerOverlay.addClass('hidden'); // скрываем спиннер
            });
        }
    });

    async function onRemove(albumId) {
        try {
            const response = await fetch(`delete?id=${albumId}`, { method: "DELETE" });

            if (response.ok) {
                sessionStorage.setItem("albumdeleted", "1");
                window.location.href = "/album";
            } else {
                $('#toasterror').toast('show');
            }
        } catch (err) {
            console.error("Delete failed", err);
            $('#toasterror').toast('show');
        }
    }
</script>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toasterror" class="toast toast-body-error" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header toast-header-error">
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div id="toastmsg" class="toast-body">
            Some error during deletion
        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastinfo_updated" class="toast toast-body-update" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Information</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div id="toastmsg" class="toast-body">
            Album updated
        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastinfo_created" class="toast toast-body-create" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Information</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div id="toastmsg" class="toast-body">
            Album created
        </div>
    </div>
</div>
<div class="modal fade" id="removeDialogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Are you sure?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Album data cannot be restored
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="onRemove(@Model.Album.Id)">Delete</button>
            </div>
        </div>
    </div>
</div>
<a id="back_button" class="btn btn-secondary mt-3" asp-action="index" asp-controller="album">Back</a>
<div class="album-container">
    <div class="album-header">
        <div class="album-title-details">
            <h1>@Model.Album.Artist.Data &mdash; @Model.Album.Data</h1>
        </div>
        <div class="album-actions">
            <a href="/album/edit/@Model.Album.Id" title="Edit">
                <i class="fa-solid fa-pen-to-square"></i>
            </a>
            <a data-bs-toggle="modal" data-bs-target="#removeDialogModal" title="Delete">
                <i class="fa-solid fa-trash"></i>
            </a>
        </div>
    </div>
    <div class="album-info-cards">
        <div class="info-card">
            <span class="info-label">Year</span>
            <span class="info-value">@Model.Album?.Year?.Data</span>
        </div>
        <div class="info-card">
            <span class="info-label">Reissue</span>
            <span class="info-value">@Model.Album?.Reissue?.Data</span>
        </div>
        <div class="info-card">
            <span class="info-label">Genre</span>
            <span class="info-value">@Model.Album?.Genre?.Data</span>
        </div>
        <div class="info-card">
            <span class="info-label">Country</span>
            <span class="info-value">@Model.Album?.Country?.Data</span>
        </div>
        <div class="info-card">
            <span class="info-label">Label</span>
            <span class="info-value">@Model.Album?.Label?.Data</span>
        </div>
        <div class="info-card">
            <span class="info-label">Size (Gb)</span>
            <span class="info-value">@Model.Album?.Size</span>
        </div>
        <div class="info-card">
            <span class="info-label">Source</span>
            <span class="info-value"><a href="@Model?.Album?.Source">@Model?.Album?.Source</a></span>
        </div>
        <div class="info-card">
            <span class="info-label">Discogs</span>
            <span class="info-value"><a href="@Model?.Album?.Discogs">@Model?.Album?.Discogs</a></span>
        </div>
        <div class="info-card">
            <span class="info-label">Added</span>
            <span class="info-value">@Model?.Album?.AddedDate</span>
        </div>
        <div class="info-card">
            <span class="info-label">Storage</span>
            <span class="info-value">@Model?.Album?.Storage?.Data</span>
        </div>
    </div>
    <div class="album-main-row">
        <div class="album-cover-box">
            <div id="coverdiv" style="position: relative;">
                <div class="spinner-overlay" id="coverSpinnerOverlay">
                    <div class="spinner-border" role="status"></div>
                </div>
                <i id="nocovericon" class="fa-regular fa-image fa-10x" style="display: none"></i>
                <img id="cover" class="album-cover justifiy-element-size" style="display: none" />
            </div>
        </div>
        <div class="album-tech-box">
            <div class="tech-info-grid">
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Vinyl state">
                    <div id="vinylstatespinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="vinylstate" class="tech-icon" alt="Vinyl state" style="display:none;" />
                    <i id="vinylstateicon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.VinylState?.Data))
                        {
                            @Model.Album.TechnicalInfo.VinylState.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Digital format">
                    <div id="digitalformatspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="digitalformat" class="tech-icon" alt="Digital format" style="display:none;" />
                    <i id="digitalformaticon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.DigitalFormat?.Data))
                        {
                            @Model.Album.TechnicalInfo.DigitalFormat.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Bitness">
                    <div id="bitnessspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="bitness" class="tech-icon" alt="Bitness" style="display:none;" />
                    <i id="bitnessicon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Bitness?.Data.ToString()))
                        {
                            @($"{Model.Album.TechnicalInfo.Bitness.Data} bit/s")
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Sampling">
                    <div id="samplingspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="sampling" class="tech-icon" alt="Sampling" style="display:none;" />
                    <i id="samplingicon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Sampling?.Data.ToString()))
                        {
                            @($"{Model.Album.TechnicalInfo.Sampling.Data}{(Model.Album.TechnicalInfo.DigitalFormat.Data.ToLower().Contains("dsd") ? " MHz" : " kHz")}")
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Source format">
                    <div id="formatspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="format" class="tech-icon" alt="Source format" style="display:none;" />
                    <i id="formaticon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.SourceFormat?.Data))
                        {
                            @Model.Album.TechnicalInfo.SourceFormat.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Player">
                    <div id="playerspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="player" class="tech-icon" alt="Player" style="display:none;" />
                    <i id="playericon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Player?.Data))
                        {
                            @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Player?.Manufacturer?.Data))
                            {
                                <b>@Model.Album.TechnicalInfo.Player.Manufacturer.Data</b>
                                <br />
                            }
                            @Model.Album.TechnicalInfo.Player.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Cartridge">
                    <div id="cartridgespinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="cartridge" class="tech-icon" alt="Cartridge" style="display:none;" />
                    <i id="cartridgeicon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Cartridge?.Data))
                        {
                            @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Cartridge?.Manufacturer?.Data))
                            {
                                <b>@Model.Album.TechnicalInfo.Cartridge.Manufacturer.Data</b>
                                <br />
                            }
                            @Model.Album.TechnicalInfo.Cartridge.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Amplifier">
                    <div id="ampspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="amp" class="tech-icon" alt="Amplifier" style="display:none;" />
                    <i id="ampicon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Amplifier?.Data))
                        {
                            @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Amplifier?.Manufacturer?.Data))
                            {
                                <b>@Model.Album.TechnicalInfo.Amplifier.Manufacturer.Data</b>
                                <br />
                            }
                            @Model.Album.TechnicalInfo.Amplifier.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="ADC">
                    <div id="adcspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="adc" class="tech-icon" alt="ADC" style="display:none;" />
                    <i id="adcicon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Adc?.Data))
                        {
                            @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Adc?.Manufacturer?.Data))
                            {
                                <b>@Model.Album.TechnicalInfo.Adc.Manufacturer.Data</b>
                                <br />
                            }
                            @Model.Album.TechnicalInfo.Adc.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Wire">
                    <div id="wirespinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="wire" class="tech-icon" alt="Wires" style="display:none;" />
                    <i id="wireicon" class="fa-regular fa-image fa-6x" style="display:none;"></i>
                    <div class="value">
                        @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Wire?.Data))
                        {
                            @if (!string.IsNullOrEmpty(Model?.Album?.TechnicalInfo?.Wire?.Manufacturer?.Data))
                            {
                                <b>@Model.Album.TechnicalInfo.Wire.Manufacturer.Data</b>
                                <br />
                            }
                            @Model.Album.TechnicalInfo.Wire.Data
                        }
                        else
                        {
                            <span style="color:#888;">No data</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>