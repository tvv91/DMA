@model AlbumDetailsViewModel
@using System.Text.Json
@using System.Text.Json.Serialization
@using Microsoft.AspNetCore.Html

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toasterror" class="toast toast-body-error" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header toast-header-error">
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div id="toastmsg" class="toast-body">
            Some error during deletion
        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastinfo_updated" class="toast toast-body-update" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Information</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div id="toastmsg" class="toast-body">
            Album updated
        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastinfo_created" class="toast toast-body-create" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Information</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div id="toastmsg" class="toast-body">
            Album created
        </div>
    </div>
</div>
<div class="modal fade" id="removeDialogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Are you sure?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Album data cannot be restored
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="onRemove(@Model.AlbumId)">Delete</button>
            </div>
        </div>
    </div>
</div>
<a id="back_button" class="btn btn-secondary mt-3" asp-action="index" asp-controller="album">Back</a>
<div class="album-container">
    <div class="album-header">
        <div class="album-title-details">
            <h1>@Model.Artist &mdash; @Model.Title</h1>
        </div>
        <div class="album-actions">
            <a href="/album/edit/@Model.AlbumId" title="Edit">
                <i class="fa-solid fa-pen-to-square"></i>
            </a>
            <a data-bs-toggle="modal" data-bs-target="#removeDialogModal" title="Delete">
                <i class="fa-solid fa-trash"></i>
            </a>
        </div>
    </div>
    <div class="album-info-cards">
        <div class="album-cover-box">
            <div id="coverdiv" style="position: relative;">
                <div class="spinner-overlay" id="coverSpinnerOverlay">
                    <div class="spinner-border" role="status"></div>
                </div>
                <i id="nocovericon" class="fa-regular fa-image fa-10x" style="display: none"></i>
                <img id="cover" class="album-cover justifiy-element-size" style="display: none" />
            </div>
        </div>
        @if (Model.Digitizations == null || !Model.Digitizations.Any())
        {
            <div class="tech-info-empty">
                <div class="empty-icon">
                    <i class="fa-solid fa-waveform-lines"></i>
                </div>
                <div class="empty-text">
                    <h3>No digitizations :(</h3>
                    <p>This album doesnâ€™t have any technical data yet.<br />Add the first digitization to see the equipment and format details.</p>
                </div>
                <a href="/digitization/create?albumId=@Model.AlbumId" class="btn btn-outline-primary mt-2">
                    <i class="fa-solid fa-plus"></i> Add digitization
                </a>
            </div>
        }
        else
        {
            <div class="tech-info-grid">
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Vinyl state">
                    <span>Vinyl state</span>
                    <div id="vinylstatespinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="vinylstate" class="tech-icon" alt="Vinyl state" style="display:none;" />
                    <i id="vinylstateicon" class="fa-regular fa-image fa-6x"></i>
                    <div id="vinylstatevalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Digital format">
                    <span>Digital format</span>
                    <div id="digitalformatspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="digitalformat" class="tech-icon" alt="Digital format" style="display:none;" />
                    <i id="digitalformaticon" class="fa-regular fa-image fa-6x"></i>
                    <div id="digitalformatvalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Bitness">
                    <span>Bitness</span>
                    <div id="bitnessspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="bitness" class="tech-icon" alt="Bitness" style="display:none;" />
                    <i id="bitnessicon" class="fa-regular fa-image fa-6x"></i>
                    <div id="bitnesstvalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Sampling">
                    <span>Sampling</span>
                    <div id="samplingspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="sampling" class="tech-icon" alt="Sampling" style="display:none;" />
                    <i id="samplingicon" class="fa-regular fa-image fa-6x"></i>
                    <div id="samplingvalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Source format">
                    <span>Source format</span>
                    <div id="formatspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="format" class="tech-icon" alt="Source format" style="display:none;" />
                    <i id="formaticon" class="fa-regular fa-image fa-6x"></i>
                    <div id="formatvalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Player">
                    <span>Player</span>
                    <div id="playerspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="player" class="tech-icon" alt="Player" style="display:none;" />
                    <i id="playericon" class="fa-regular fa-image fa-6x"></i>
                    <div id="playervalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Cartridge">
                    <span>Cartridge</span>
                    <div id="cartridgespinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="cartridge" class="tech-icon" alt="Cartridge" style="display:none;" />
                    <i id="cartridgeicon" class="fa-regular fa-image fa-6x"></i>
                    <div id="cartridgevalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Amplifier">
                    <span>Amplifier</span>
                    <div id="ampspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="amp" class="tech-icon" alt="Amplifier" style="display:none;" />
                    <i id="ampicon" class="fa-regular fa-image fa-6x"></i>
                    <div id="ampvalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="ADC">
                    <span>Adc</span>
                    <div id="adcspinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="adc" class="tech-icon" alt="ADC" style="display:none;" />
                    <i id="adcicon" class="fa-regular fa-image fa-6x"></i>
                    <div id="adcvalue"></div>
                </div>
                <div class="tech-card" data-toggle="tooltip" data-placement="top" title="Wire">
                    <span>Wire</span>
                    <div id="wirespinner" class="spinner-border text-secondary" role="status"></div>
                    <img id="wire" class="tech-icon" alt="Wires" style="display:none;" />
                    <i id="wireicon" class="fa-regular fa-image fa-6x"></i>
                    <div id="wirevalue"></div>
                </div>
            </div>
        }
    </div>
    <div class="info-card">
        Genre: <b>@Model.Genre</b>
        &nbsp;|&nbsp;
        Digitizations: <b>@Model.Digitizations?.Count()</b>

        @if (Model.AddedDate != null)
        {
            @:&nbsp;|&nbsp; Added: <b>@Model.AddedDate</b>
        }

        @if (Model.UpdateDate != null)
        {
            @:&nbsp;|&nbsp; Updated: <b>@Model.UpdateDate</b>
        }
        <hr />
        <div id="digitizationinfo"></div>
    </div>
    <div class="digitization-table">
        <div class="table-header">
            <div class="col col-vinyl">Vinyl state</div>
            <div class="col col-bitness">Bitness</div>
            <div class="col col-sampling">Sampling</div>
            <div class="col col-format">Format</div>
            <div class="col col-source">Source</div>
            <div class="col col-player">Player</div>
            <div class="col col-cartridge">Cartridge</div>
            <div class="col col-amplifier">Amplifier</div>
            <div class="col col-adc">ADC</div>
            <div class="col col-wire">Wire</div>
        </div>
        <div class="table-body" id="digitizationTableBody">
            @if (Model.Digitizations != null && Model.Digitizations.Any())
            {
                foreach (var d in Model.Digitizations)
                {
                    bool isDsd = d.FormatInfo?.DigitalFormat?.Name?.Contains("dsd", StringComparison.OrdinalIgnoreCase) == true;
                    <div class="table-row" data-id="@d.Id">
                        <div class="col col-vinyl">
                            @if (!string.IsNullOrWhiteSpace(d.FormatInfo?.VinylState?.Name))
                            {
                                @d.FormatInfo.VinylState.Name
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-bitness">
                            @if (d.FormatInfo?.Bitness?.Value != null)
                            {
                                @($"{d.FormatInfo.Bitness.Value} bit/s")
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-sampling">
                            @if (d.FormatInfo?.Sampling?.Value != null)
                            {
                                @($"{d.FormatInfo.Sampling.Value} {(isDsd ? "MHz" : "kHz")}")
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-format">
                            @if (!string.IsNullOrWhiteSpace(d.FormatInfo?.DigitalFormat?.Name))
                            {
                                @d.FormatInfo.DigitalFormat.Name
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-source">
                            @if (!string.IsNullOrWhiteSpace(d.FormatInfo?.SourceFormat?.Name))
                            {
                                @d.FormatInfo.SourceFormat.Name
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-player">
                            @if (!string.IsNullOrWhiteSpace(d.EquipmentInfo?.Player?.Name) || !string.IsNullOrWhiteSpace(d.EquipmentInfo?.Player?.Manufacturer?.Name))
                            {
                                var player = d.EquipmentInfo!.Player!;
                                if (player.Id > 0)
                                {
                                    <a href="/equipment/Player/@player.Id" target="_blank" rel="noopener noreferrer">
                                        <b>@player.Manufacturer?.Name</b><br />@player.Name
                                    </a>
                                }
                                else
                                {
                                    <b>@player.Manufacturer?.Name</b><br />@player.Name
                                }
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-cartridge">
                            @if (!string.IsNullOrWhiteSpace(d.EquipmentInfo?.Cartridge?.Name) || !string.IsNullOrWhiteSpace(d.EquipmentInfo?.Cartridge?.Manufacturer?.Name))
                            {
                                var cartridge = d.EquipmentInfo!.Cartridge!;
                                if (cartridge.Id > 0)
                                {
                                    <a href="/equipment/Cartridge/@cartridge.Id" target="_blank" rel="noopener noreferrer">
                                        <b>@cartridge.Manufacturer?.Name</b><br />@cartridge.Name
                                    </a>
                                }
                                else
                                {
                                    <b>@cartridge.Manufacturer?.Name</b><br />@cartridge.Name
                                }
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-amplifier">
                            @if (!string.IsNullOrWhiteSpace(d.EquipmentInfo?.Amplifier?.Name) || !string.IsNullOrWhiteSpace(d.EquipmentInfo?.Amplifier?.Manufacturer?.Name))
                            {
                                var amplifier = d.EquipmentInfo!.Amplifier!;
                                if (amplifier.Id > 0)
                                {
                                    <a href="/equipment/Amplifier/@amplifier.Id" target="_blank" rel="noopener noreferrer">
                                        <b>@amplifier.Manufacturer?.Name</b><br />@amplifier.Name
                                    </a>
                                }
                                else
                                {
                                    <b>@amplifier.Manufacturer?.Name</b><br />@amplifier.Name
                                }
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-adc">
                            @if (!string.IsNullOrWhiteSpace(d.EquipmentInfo?.Adc?.Name) || !string.IsNullOrWhiteSpace(d.EquipmentInfo?.Adc?.Manufacturer?.Name))
                            {
                                var adc = d.EquipmentInfo!.Adc!;
                                if (adc.Id > 0)
                                {
                                    <a href="/equipment/Adc/@adc.Id" target="_blank" rel="noopener noreferrer">
                                        <b>@adc.Manufacturer?.Name</b><br />@adc.Name
                                    </a>
                                }
                                else
                                {
                                    <b>@adc.Manufacturer?.Name</b><br />@adc.Name
                                }
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                        <div class="col col-wire">
                            @if (!string.IsNullOrWhiteSpace(d.EquipmentInfo?.Wire?.Name) || !string.IsNullOrWhiteSpace(d.EquipmentInfo?.Wire?.Manufacturer?.Name))
                            {
                                var wire = d.EquipmentInfo!.Wire!;
                                if (wire.Id > 0)
                                {
                                    <a href="/equipment/Wire/@wire.Id" target="_blank" rel="noopener noreferrer">
                                        <b>@wire.Manufacturer?.Name</b><br />@wire.Name
                                    </a>
                                }
                                else
                                {
                                    <b>@wire.Manufacturer?.Name</b><br />@wire.Name
                                }
                            }
                            else
                            {
                                <span class="tech-no-data">No data</span>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="table-row">
                    <div class="col" style="grid-column: span 10; text-align:center; color:#888;">
                        No digitizations available
                    </div>
                </div>
            }
        </div>
    </div>
</div>
<script>
    const digitizations = @Html.Raw(JsonSerializer.Serialize(Model.Digitizations, new JsonSerializerOptions { ReferenceHandler = ReferenceHandler.IgnoreCycles }))
    
    $(document).ready(async () => {
        await start();
        await getAlbumCover(@Model.AlbumId);

        showToastFromStorage("albumupdated", "toastinfo_updated");
        showToastFromStorage("albumcreated", "toastinfo_created");

        const backIndex = localStorage.getItem("BACK_PAGE_INDEX");
        if (backIndex && backIndex !== "1") {
            $("#back_button").attr("href", `/album?page=${backIndex}`);
        }
        $('.table-row').each(function (i) {
            const $row = $(this);
            setTimeout(() => $row.addClass('visible'), i * 100);
        });

        $('.table-row').on('click', async function () {
            $('.table-row').removeClass('selected');
            $(this).addClass('selected');

            const id = $(this).data('id');
            if (id) {
                resetSpinners();
                await getTechnicalInfoIcons(id);
                setDigitizationValue(id);
            }
    });

    const $firstRow = $('.table-row').first();
    if ($firstRow.length) {
        $firstRow.addClass('selected');
        const id = $firstRow.data('id');
            if (id) {
                resetSpinners();
                await getTechnicalInfoIcons(id);
                setDigitizationValue(id);
            }
        }
    })

    function setDigitizationValue(id) {
        const item = digitizations.find(x => x.Id === id);

        if (!item) {
            console.warn("Digitization not found for id:", id);
            return;
        }

        const fi = item.FormatInfo ?? {};
        const ei = item.EquipmentInfo ?? {};
        const bitness = fi.Bitness?.Value;
        const sampling = fi.Sampling?.Value;
        const isDsd = fi.DigitalFormat?.Name?.toLowerCase()?.includes("dsd");

        $('#vinylstatevalue').text(fi.VinylState?.Name || "");
        $('#digitalformatvalue').text(fi.DigitalFormat?.Name || "");
        $('#bitnesstvalue').text(bitness ? `${bitness} bit/s` : "");
        $('#samplingvalue').text(sampling ? `${sampling} ${isDsd ? "MHz" : "kHz"}` : "");
        $('#formatvalue').text(fi.SourceFormat?.Name || "");
        $('#playervalue').html(`<b>${ei.Player?.Manufacturer?.Name ?? ''}</b><br>${ei.Player?.Name ?? ''}`);
        $('#cartridgevalue').html(`<b>${ei.Cartridge?.Manufacturer?.Name ?? ''}</b><br>${ei.Cartridge?.Name ?? ''}`);
        $('#ampvalue').html(`<b>${ei.Amplifier?.Manufacturer?.Name ?? ''}</b><br>${ei.Amplifier?.Name ?? ''}`);
        $('#adcvalue').html(`<b>${ei.Adc?.Manufacturer?.Name ?? ''}</b><br>${ei.Adc?.Name ?? ''}`);
        $('#wirevalue').html(`<b>${ei.Wire?.Manufacturer?.Name ?? ''}</b><br>${ei.Wire?.Name ?? ''}`);
        $('#digitizationinfo').text(item.Size + " Gb");

        const headers = [];
        const values = [];

        function addCell(label, value) {
            if (!value) return;
            headers.push(`<th>${label}</th>`);
            values.push(`<td>${value}</td>`);
        }

        addCell("Year", item.Year?.Value);
        addCell("Reissue", item.Reissue?.Value);
        addCell("Size", item.Size ? `${item.Size} GB` : null);
        addCell("First press", item.IsFirstPress ? "Yes" : null);
        addCell("Label", item.Label?.Name);
        addCell("Country", item.Country?.Name);
        addCell("Storage", item.Storage?.Data);
        addCell("Source", item.Source ? `<a href="${item.Source}" target="_blank">LINK</a>` : null);
        addCell("Discogs", item.Discogs ? `<a href="${item.Discogs}" target="_blank">LINK</a>` : null);
        addCell("Added", item.AddedDate ? new Date(item.AddedDate).toLocaleDateString() : null);
        addCell("Updated", item.UpdateDate ? new Date(item.UpdateDate).toLocaleDateString() : null);

        $('#digitizationinfo').html(`
            <table class="digitization-spec">
                <tr>${headers.join("")}</tr>
                <tr>${values.join("")}</tr>
            </table>
        `);
    }

    function showToastFromStorage(key, toastId) {
        if (sessionStorage.getItem(key) === "1") {
            $(`#${toastId}`).toast("show");
            sessionStorage.removeItem(key);
        }
    }

    async function getTechnicalInfoIcons(albumId) {
        try {
            await connection.invoke("GetTechnicalInfoIcons", connection.connectionId, albumId);
        } catch (err) {
            console.log("Error sending request to GetTechnicalInfoIcons");
        }
    }

    async function getAlbumCover(albumId) {
        try {
            await connection.invoke("GetAlbumCover", connection.connectionId, albumId);
        } catch (err) {
            console.log("Error sending request to GetAlbumCover");
        }
    }

    connection.on("ReceivedTechnicalInfoIcon", (category, cover) => {
        const $spinner = $(`#${category}spinner`);
        const $img = $(`#${category}`);
        let $icon = $(`#${category}icon`);

        // Check if elements exist (defensive check)
        if ($spinner.length === 0 || $img.length === 0) {
            return;
        }

        $spinner.hide();

        if (cover === null) {
            $img.hide();
            if (!$icon.length || !$icon.hasClass('tech-no-data')) {
                $icon.replaceWith(`<div id="${category}icon" class="tech-no-data">No data</div>`);
                $icon = $(`#${category}icon`);
            }
            $icon.show();
        }
        else if (cover.toLowerCase().includes("nocover")) {
            $img.hide();
            if (!$icon.length || !$icon.is('i')) {
                $icon.replaceWith(`<i id="${category}icon" class="fa-regular fa-image fa-6x"></i>`);
                $icon = $(`#${category}icon`);
            }
            $icon.show();
        }
        else {
            // Attach event handlers before setting src to handle cached images
            $img.off("load error")
                .on("load", () => {
                    $img.show();
                    if ($icon.length) 
                        $icon.hide();
                })
                .on("error", () => {
                    // If image fails to load, show placeholder icon
                    $img.hide();
                    if (!$icon.length || !$icon.is('i')) {
                        $icon.replaceWith(`<i id="${category}icon" class="fa-regular fa-image fa-6x"></i>`);
                        $icon = $(`#${category}icon`);
                    }
                    $icon.show();
                });
            
            // Set src after handlers are attached
            $img.attr("src", cover);
            
            // Check if image is already loaded (cached images)
            if ($img[0].complete && $img[0].naturalHeight !== 0) {
                $img.show();
                if ($icon.length) 
                    $icon.hide();
            } else if ($img[0].complete && $img[0].naturalHeight === 0) {
                // Image failed to load
                $img.trigger("error");
            }
        }
    });
    
    function resetSpinners() {
        $('.tech-info-grid [id$="spinner"]').show();
        $('.tech-info-grid img.tech-icon').hide();
        $('.tech-info-grid [id$="icon"]').hide();
    }

    connection.on("ReceivedAlbumCoverDetailed", (cover) => {
        const $cover = $('#cover');
        const $spinnerOverlay = $('#coverSpinnerOverlay');
        const $noCover = $('#nocovericon');

        // Check if elements exist (defensive check)
        if ($cover.length === 0 || $spinnerOverlay.length === 0) {
            return;
        }

        if (cover.includes("nocover")) {
            $noCover.show();
            $spinnerOverlay.addClass('hidden');
            $('#coverdiv').css("border", "solid");
            $cover.hide();
        } else {
            // Attach event handlers before setting src to handle cached images
            $cover.off("load error")
                  .on('load', () => {
                      $cover.addClass('loaded');
                      $spinnerOverlay.addClass('hidden');
                      $noCover.hide();
                      $('#coverdiv').css("border", "none");
                  })
                  .on('error', () => {
                      // If image fails to load, show no cover icon
                      $spinnerOverlay.addClass('hidden');
                      $noCover.show();
                      $cover.hide();
                      $('#coverdiv').css("border", "solid");
                  });
            
            // Set src after handlers are attached
            $cover.attr("src", cover).show();
            
            // Check if image is already loaded (cached images)
            if ($cover[0].complete && $cover[0].naturalHeight !== 0) {
                $cover.addClass('loaded');
                $spinnerOverlay.addClass('hidden');
                $noCover.hide();
                $('#coverdiv').css("border", "none");
            } else if ($cover[0].complete && $cover[0].naturalHeight === 0) {
                // Image failed to load
                $cover.trigger("error");
            }
        }
    });

    async function onRemove(albumId) {
        try {
            const response = await fetch(`delete?id=${albumId}`, { method: "DELETE" });

            if (response.ok) {
                sessionStorage.setItem("albumdeleted", "1");
                window.location.href = "/album";
            } else {
                $('#toasterror').toast('show');
            }
        } catch (err) {
            console.error("Delete failed", err);
            $('#toasterror').toast('show');
        }
    }
</script>